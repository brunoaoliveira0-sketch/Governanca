<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal CSC - Desempenho e Governança</title>

    <!-- Tailwind CSS (Estilos) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome (Ícones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel (Compilador para ler código React no navegador) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map para o Firebase funcionar via internet -->
    <script type="importmap">
      {
        "imports": {
          "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
      }
    </script>
</head>
<body class="bg-gray-900 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, writeBatch, getDocs, setDoc, getDoc } from 'firebase/firestore';

        const { useState, useEffect, useRef } = React;

        // ==========================================
        // 1. CONFIGURAÇÃO FIREBASE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBRGnWbrVV9iaXp2YLjfZ9qLCcyDNbdvCA",
            authDomain: "csc-desempenho.firebaseapp.com",
            projectId: "csc-desempenho",
            storageBucket: "csc-desempenho.firebasestorage.app",
            messagingSenderId: "962492039958",
            appId: "1:962492039958:web:8a82e852faf69d0cf40637",
            measurementId: "G-81B2NDZX71"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Erro ao inicializar Firebase.", e);
        }

        const appId = "painel-gov-csc-producao";

        // ==========================================
        // 2. CONSTANTES E DADOS ESTÁTICOS
        // ==========================================
        const BACKGROUND_IMAGE = "GPTW_Fundo Teams.jpg"; 
        const MONTHS = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const GOV_MONTHS_ROWS = [
          "JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", 
          "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"
        ];

        const RT_GOV_ITEMS = [
          "NÍVEL DE SERVIÇOS CSC TI E TELECOM - EQTL ENERGIA", "Nível de Serviços CSC Operações de TI - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC OPERAÇÕES DE TI - EQTL MA",
          "NÍVEL DE SERVIÇOS CSC OPERAÇÕES DE TI - EQTL PA", "NÍVEL DE SERVIÇOS CSC OPERAÇÕES DE TI - EQTL PI", "NÍVEL DE SERVIÇOS CSC OPERAÇÕES DE TI - EQTL CEA CSA",
          "NÍVEL DE SERVIÇOS CSC OPERAÇÕES DE TI - EQTL CEEE", "NÍVEL DE SERVIÇOS CSC OPERAÇÕES DE TI - EQTL GO", "NÍVEL DE SERVIÇOS CSC OPERAÇÕES DE TI - EQTL AL",
          "NÍVEL DE SERVIÇOS CSC TELECOM - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC SISTEMAS TÉCNICOS - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC SISTEMAS CORPORATIVOS - EQTL ENERGIA",
          "Nível de Serviços CSC Canais Digitais - EQTL ENERGIA", "Nível de Serviços CSC Sistemas Administrativos - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC SISTEMAS AUXILIARES - EQTL ENERGIA",
          "NÍVEL DE SERVIÇOS CSC ARQ INFRA E CLOUD - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC SEGURANÇA DA INFORMAÇÃO - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC SUPRIMENTOS - EQTL ENERGIA",
          "NÍVEL DE SERVIÇOS CSC SUPRIMENTOS DE MATERIAIS - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC COMPRAS DE MATERIAIS - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC MATERIAIS DE REDES - EQTL ENERGIA",
          "NÍVEL DE SERVIÇOS CSC BPO - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC SUPRIMENTOS DE SERVIÇOS - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC COMPRAS AT MTBT CORP TI - EQTL ENERGIA",
          "NÍVEL DE SERVIÇOS CSC COMPRAS AT - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC COMPRAS MTBT - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC COMPRAS TI - EQTL ENERGIA",
          "NÍVEL DE SERVIÇOS CSC COMPRAS CORPORATIVAS - EQTL ENERGIA", "NÍVEL DE SERVIÇOS CSC COMPRAS SANEAMENTO E RENOVÁVEIS - EQTL ENERGIA", "NIVEL DE SERVIÇOS CSC FAC SEG EMPRESARIAL E SERV FIN - EQTL ENERGIA",
          "Nível de Serviços CSC Serviços Financeiros - EQTL ENERGIA", "Nível de Serviços CSC Folha e Benefícios - EQTL ENERGIA", "Nível de Serviços CSC Pagamentos e Viagens - EQTL ENERGIA",
          "NÍVEL DE SERVIÇOS CSC RECEBIMENTO FISCAL - EQTL ENERGIA", "NÍVEL DE SERVIÇO CSC FACILITIES - EQTL ENERGIA", "NÍVEL DE SERVIÇO CSC FACILITIES - EQTL AL",
          "NÍVEL DE SERVIÇO CSC FACILITIES - EQTL MA", "NÍVEL DE SERVIÇO CSC FACILITIES - EQTL PA", "NÍVEL DE SERVIÇO CSC FACILITIES - EQTL PI",
          "NÍVEL DE SERVIÇO CSC FACILITIES - EQTL CEA CSA", "NÍVEL DE SERVIÇO CSC FACILITIES - EQTL CEEE", "NÍVEL DE SERVIÇO CSC FACILITIES - EQTL GO DF",
          "NIVEL DE SERVIÇOS CSC SEGURANÇA PATRIMONIAL - EQTL ENERGIA", "SLA ATENDIMENTO CSC GOV COMPRAS - EQTL ENERGIA", "SLA ATENDIMENTO CSC FROTA - EQTL AL",
          "SLA ATENDIMENTO CSC IMOVEIS - EQTL AL LESTE", "SLA ATENDIMENTO CSC IMÓVEIS - EQTL AL OESTE", "SLA Atendimento CSC - EQTL Serviços e Telecom - FACILITIES - IMÓVEIS - PG",
          "SLA Atendimento CSC - EQTL Serviços e Telecom - FACILITIES - FROTA - PG", "SLA Atendimento CSC - EQTL ENERGIA - CADASTRO", "SLA ATENDIMENTO CSC FROTA - EQTL PA",
          "BACKLOG CSC OPERAÇÕES DE TI – EQTL MA", "BACKLOG CSC OPERAÇÕES DE TI – EQTL PA", "BACKLOG CSC OPERAÇÕES DE TI – EQTL PI", "BACKLOG CSC OPERAÇÕES DE TI – EQTL AL",
          "BACKLOG CSC OPERAÇÕES DE TI – EQTL CEA CSA", "BACKLOG CSC OPERAÇÕES DE TI – EQTL CEEE", "BACKLOG CSC OPERAÇÕES DE TI – EQTL GO DF",
          "BACKLOG CSC - EQTL ENERGIA - RECEBIMENTO FISCAL", "BACKLOG CSC SISTEMAS CORPORATIVOS – EQTL ENERGIA", "BACKLOG CSC SISTEMAS TÉCNICOS – EQTL ENERGIA",
          "Backlog CSC Segurança Empresarial – EQTL ENERGIA", "Backlog CSC Imóveis - EQTL AL LESTE", "Backlog CSC Imóveis - EQTL AL OESTE", "Backlog CSC Frota - EQTL AL",
          "BACKLOG CSC IMÓVEIS FROTA - EQTL CEEE D NORTE", "BACKLOG CSC IMÓVEIS FROTA - EQTL CEEE D SUL", "BACKLOG CSC - EQTL CEACSA - IMÓVEIS + FROTA",
          "BACKLOG CSC - EQTL MA - IMÓVEIS + FROTA CENTRO", "BACKLOG CSC - EQTL MA - IMÓVEIS + FROTA LESTE", "BACKLOG CSC - EQTL MA - IMÓVEIS + FROTA NOROESTE",
          "BACKLOG CSC - EQTL MA - IMÓVEIS + FROTA NORTE", "BACKLOG CSC - EQTL MA - IMÓVEIS + FROTA SUL", "BACKLOG CSC - EQTL PA - IMÓVEIS + FROTA CENTRO",
          "BACKLOG CSC - EQTL PA - IMÓVEIS + FROTA NORDESTE", "BACKLOG CSC - EQTL PA - IMÓVEIS + FROTA NORTE", "BACKLOG CSC - EQTL PA - IMÓVEIS + FROTA OESTE",
          "BACKLOG CSC - EQTL PA - IMÓVEIS + FROTA SUL", "BACKLOG CSC - EQTL PI - IMÓVEIS + FROTA FLORIANO", "BACKLOG CSC - EQTL PI - IMÓVEIS + FROTA METROPOLITANA",
          "BACKLOG CSC - EQTL PI - IMÓVEIS + FROTA PARNAÍBA", "BACKLOG CSC - EQTL GO - IMÓVEIS + FROTA CENTRO", "BACKLOG CSC - EQTL GO - IMÓVEIS + FROTA NOROESTE",
          "BACKLOG CSC - EQTL GO - IMÓVEIS + FROTA NORTE", "BACKLOG CSC - EQTL GO - IMÓVEIS + FROTA SUDOESTE", "BACKLOG CSC - EQTL GO - IMÓVEIS + FROTA SUL",
          "Backlog CSC - EQTL ENERGIA Sistemas", "Backlog CSC - EQTL ENERGIA - Benefícios", "BACKLOG CSC - EQTL ENERGIA - FOLHA E BENEFÍCIOS"
        ];

        // ==========================================
        // 3. GERADORES DE DADOS
        // ==========================================
        const generateServiceLevelData = () => {
          const regions = ["EQTL ENERGIA", "EQTL MARANHÃO", "EQTL PARÁ", "EQTL PIAUÍ", "EQTL ALAGOAS", "EQTL GOIÁS", "EQTL CEEE-D", "EQTL AMAPÁ", "EQTL SERVIÇOS", "EQTL TELECOM"];
          
          const structure = [
            { type: 'TI e Telecom', color: 'bg-green-100', items: [
                { suffix: "", weight: 1, target: 98.0, isMain: true },
                { suffix: "Incidentes Críticos de TI e Telecom", weight: 0.35, target: 100.0, isMain: false },
                { suffix: "Incidentes Não Críticos de TI e Telecom", weight: 0.35, target: 98.0, isMain: false },
                { suffix: "Requisições de TI e Telecom", weight: 0.30, target: 98.0, isMain: false }
            ]},
            { type: 'Suprimentos', color: 'bg-orange-100', items: [
                { suffix: "", weight: 1, target: 95.0, isMain: true },
                { suffix: "Atendimentos SN", weight: 0.3, target: 95.0, isMain: false },
                { suffix: "Atendimentos Coupa", weight: 0.3, target: 95.0, isMain: false },
                { suffix: "Eficiência", weight: 0.4, target: 95.0, isMain: false }
            ]},
            { type: 'Facilities', color: 'bg-yellow-100', items: [
                { suffix: "", weight: 1, target: 95.0, isMain: true },
                { suffix: "Manutenção", weight: 0.5, target: 95.0, isMain: false },
                { suffix: "Limpeza", weight: 0.3, target: 95.0, isMain: false },
                { suffix: "Frota", weight: 0.2, target: 95.0, isMain: false }
            ]},
            { type: 'RH', color: 'bg-purple-100', items: [
                { suffix: "", weight: 1, target: 95.0, isMain: true },
                { suffix: "Folha", weight: 0.4, target: 95.0, isMain: false },
                { suffix: "Benefícios", weight: 0.4, target: 95.0, isMain: false },
                { suffix: "Ponto", weight: 0.2, target: 95.0, isMain: false }
            ]},
             { type: 'Financeiro', color: 'bg-blue-100', items: [
                { suffix: "", weight: 1, target: 95.0, isMain: true },
                { suffix: "Contas a Pagar", weight: 0.5, target: 95.0, isMain: false },
                { suffix: "Contas a Receber", weight: 0.5, target: 95.0, isMain: false }
            ]},
             { type: 'Jurídico', color: 'bg-red-100', items: [
                { suffix: "", weight: 1, target: 95.0, isMain: true },
                { suffix: "Contratos", weight: 0.5, target: 95.0, isMain: false },
                { suffix: "Trabalhista", weight: 0.5, target: 95.0, isMain: false }
            ]}
          ];

          let data = [];
          regions.forEach(reg => {
            structure.forEach(group => {
              group.items.forEach((item, idx) => {
                let name = idx === 0 ? `Nível de Serviços CSC ${group.type} - ${reg}` : `Resultado Super. ${group.type} ${item.suffix} - ${reg}`;
                data.push({ 
                    name, target: item.target, weight: item.weight, type: "percent", 
                    direction: "max", isMain: item.isMain, groupColor: group.color 
                });
              });
            });
          });
          return data.map((d, i) => ({ ...d, order: i, months: Array.from({length: 12}, () => ({ falseVal: null, trueVal: null, real: null, acum: null })) }));
        };

        const generateSlaData = () => {
          const specificSlaList = [
            "SLA ATENDIMENTO CSC GOV COMPRAS - EQTL ENERGIA", "SLA ATENDIMENTO CSC FROTA - EQTL AL", "SLA ATENDIMENTO CSC IMOVEIS - EQTL AL LESTE",
            "SLA ATENDIMENTO CSC IMÓVEIS - EQTL AL OESTE", "SLA Atendimento CSC - EQTL Serviços e Telecom - FACILITIES - IMÓVEIS - PG",
            "SLA Atendimento CSC - EQTL Serviços e Telecom - FACILITIES - FROTA - PG", "SLA Atendimento CSC - EQTL ENERGIA - CADASTRO", "SLA ATENDIMENTO CSC FROTA - EQTL PA"
          ];
          return specificSlaList.map((name, i) => ({ 
            name, target: 95.0, type: "percent", direction: "max", isMain: true, order: i, 
            months: Array.from({length: 12}, () => ({ falseVal: null, trueVal: null, real: null, acum: null })) 
          }));
        };

        const generateBacklogData = () => {
          const backlogList = [
            "Backlog CSC Operações de TI – EQTL MA", "Backlog CSC Operações de TI – EQTL PA", "Backlog CSC Operações de TI – EQTL PI", "Backlog CSC Operações de TI – EQTL AL",
            "Backlog CSC Operações de TI – EQTL CEA CSA", "Backlog CSC Operações de TI – EQTL CEEE", "Backlog CSC Operações de TI – EQTL GO DF",
            "BACKLOG CSC - EQTL ENERGIA - RECEBIMENTO FISCAL", "BACKLOG CSC SISTEMAS CORPORATIVOS – EQTL ENERGIA", "BACKLOG CSC SISTEMAS TÉCNICOS – EQTL ENERGIA",
            "Backlog CSC Segurança Empresarial – EQTL ENERGIA", "Backlog CSC Imóveis - EQTL AL LESTE", "Backlog CSC Imóveis - EQTL AL OESTE", "Backlog CSC Frota - EQTL AL",
            "BACKLOG CSC IMÓVEIS FROTA - EQTL CEEE D NORTE", "BACKLOG CSC IMÓVEIS FROTA - EQTL CEEE D SUL", "BACKLOG CSC - EQTL CEACSA - IMÓVEIS + FROTA",
            "BACKLOG CSC - EQTL MA - IMÓVEIS + FROTA CENTRO", "BACKLOG CSC - EQTL MA - IMÓVEIS + FROTA LESTE", "BACKLOG CSC - EQTL MA - IMÓVEIS + FROTA NOROESTE",
            "BACKLOG CSC - EQTL MA - IMÓVEIS + FROTA NORTE", "BACKLOG CSC - EQTL MA - IMÓVEIS + FROTA SUL", "BACKLOG CSC - EQTL PA - IMÓVEIS + FROTA CENTRO",
            "BACKLOG CSC - EQTL PA - IMÓVEIS + FROTA NORDESTE", "BACKLOG CSC - EQTL PA - IMÓVEIS + FROTA NORTE", "BACKLOG CSC - EQTL PA - IMÓVEIS + FROTA OESTE",
            "BACKLOG CSC - EQTL PA - IMÓVEIS + FROTA SUL", "BACKLOG CSC - EQTL PI - IMÓVEIS + FROTA FLORIANO", "BACKLOG CSC - EQTL PI - IMÓVEIS + FROTA METROPOLITANA",
            "BACKLOG CSC - EQTL PI - IMÓVEIS + FROTA PARNAÍBA", "BACKLOG CSC - EQTL GO - IMÓVEIS + FROTA CENTRO", "BACKLOG CSC - EQTL GO - IMÓVEIS + FROTA NOROESTE",
            "BACKLOG CSC - EQTL GO - IMÓVEIS + FROTA NORTE", "BACKLOG CSC - EQTL GO - IMÓVEIS + FROTA SUDOESTE", "BACKLOG CSC - EQTL GO - IMÓVEIS + FROTA SUL",
            "Backlog CSC - EQTL ENERGIA Sistemas", "Backlog CSC - EQTL ENERGIA - Benefícios", "BACKLOG CSC - EQTL ENERGIA - FOLHA E BENEFÍCIOS"
          ];
          return backlogList.map((name, i) => ({ 
            name, target: 20, type: "number", direction: "min", isMain: true, order: i, 
            months: Array.from({length: 12}, () => ({ falseVal: null, trueVal: null, real: null, acum: null })) 
          }));
        };

        // ==========================================
        // 4. COMPONENTES AUXILIARES
        // ==========================================
        const IndicatorChartModal = ({ indicator, onClose }) => {
          const svgRef = useRef(null);
          if (!indicator) return null;
          
          const chartData = indicator.months.map((m, idx) => ({ name: MONTHS[idx], real: m.real || 0, acum: m.acum || 0 }));
          const barColor = "#3b82f6"; const lineColor = "#10b981";
          const width = 600; const height = 300; const padding = 40; const graphWidth = width - padding * 2; const graphHeight = height - padding * 2; const maxY = Math.max(100, ...chartData.map(d => d.real)) || 100;
          const getX = (index) => padding + (index * (graphWidth / (chartData.length - 1 || 1)));
          const getY = (val) => height - padding - ((val / maxY) * graphHeight);
          const linePath = chartData.reduce((acc, point, i) => {
            const x = getX(i); const y = getY(point.acum); return i === 0 ? `M ${x} ${y}` : `${acc} L ${x} ${y}`;
          }, "");

          const exportChart = () => {
            if (!svgRef.current) return;
            const svg = svgRef.current;
            const svgData = new XMLSerializer().serializeToString(svg);
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const img = new Image();
            
            img.onload = () => {
              canvas.width = width;
              canvas.height = height;
              ctx.fillStyle = "white"; 
              ctx.fillRect(0, 0, width, height);
              ctx.drawImage(img, 0, 0);
              const a = document.createElement("a");
              a.download = `Grafico_${indicator.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;
              a.href = canvas.toDataURL("image/png");
              a.click();
            };
            
            img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgData)));
          };

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
              <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-3xl relative">
                
                <div className="flex justify-between items-start mb-6 pr-6">
                  <div>
                     <h3 className="text-xl font-bold text-gray-800 mb-2 truncate" title={indicator.name}>{indicator.name}</h3>
                     <div className="flex gap-4 text-xs text-gray-500 font-medium">
                       <span className="flex items-center gap-1.5"><div className="w-3 h-3 bg-blue-500 rounded-sm"></div> Real Mensal</span>
                       <span className="flex items-center gap-1.5"><div className="w-3 h-3 bg-emerald-500 rounded-full h-[3px]"></div> Acumulado Anual</span>
                       <span className="bg-gray-100 px-2 py-0.5 rounded text-gray-700">Meta: {indicator.target}{indicator.type === 'percent' ? '%' : ''}</span>
                     </div>
                  </div>
                  <button onClick={exportChart} className="shrink-0 text-sm bg-blue-50 hover:bg-blue-100 text-blue-600 px-4 py-2 rounded-lg flex items-center gap-2 font-bold transition-colors border border-blue-200 shadow-sm">
                      <i className="fas fa-download"></i> Exportar Gráfico
                  </button>
                </div>

                <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition-colors">
                    <i className="fas fa-times w-5 h-5 flex items-center justify-center"></i>
                </button>

                <div className="flex justify-center bg-gray-50/50 rounded-xl p-4 border border-gray-100">
                  <svg ref={svgRef} xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox={`0 0 ${width} ${height}`} className="w-full h-auto overflow-visible bg-white rounded">
                    <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#e5e7eb" strokeWidth="1.5" />
                    <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#e5e7eb" strokeWidth="1.5" />
                    {[0, maxY/2, maxY].map(val => (
                      <g key={val}>
                        <line x1={padding} y1={getY(val)} x2={width - padding} y2={getY(val)} stroke="#f3f4f6" strokeDasharray="4" />
                        <text x={padding - 10} y={getY(val) + 4} textAnchor="end" fontSize="11" fontFamily="sans-serif" fill="#9ca3af" fontWeight="bold">{Math.round(val)}</text>
                      </g>
                    ))}
                    {chartData.map((d, i) => {
                      const barH = ((d.real / maxY) * graphHeight);
                      return (
                        <g key={i}>
                          <rect x={getX(i) - 12} y={getY(d.real)} width={24} height={barH} fill={barColor} opacity="0.85" rx="3"/>
                          <text x={getX(i)} y={height - padding + 20} textAnchor="middle" fontSize="11" fontFamily="sans-serif" fill="#6b7280" fontWeight="bold">{d.name}</text>
                        </g>
                      )
                    })}
                    <path d={linePath} fill="none" stroke={lineColor} strokeWidth="3.5" strokeLinecap="round" strokeLinejoin="round" />
                    {chartData.map((d, i) => (<circle key={i} cx={getX(i)} cy={getY(d.acum)} r="4.5" fill="white" stroke={lineColor} strokeWidth="2.5" />))}
                  </svg>
                </div>
              </div>
            </div>
          );
        };

        const GovBiChartModalComponent = ({ title, data, target, chartType, lowerIsBetter, onClose, isTma = false }) => {
          const svgRef = useRef(null);
          
          const validData = data.map(d => d === null || isNaN(d) ? 0 : d);
          const rawMax = Math.max(target, ...validData);
          const maxY = isTma ? rawMax * 1.5 : (rawMax * 1.2 || 100);

          const width = 600; const height = 300; const padding = 50; 
          const graphWidth = width - padding * 2; const graphHeight = height - padding * 2; 
          
          const getX = (index) => padding + (index * (graphWidth / (validData.length - 1 || 1)));
          const getY = (val) => height - padding - ((val / maxY) * graphHeight);
          
          const exportChart = () => {
            if (!svgRef.current) return;
            const svg = svgRef.current;
            const svgData = new XMLSerializer().serializeToString(svg);
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const img = new Image();
            
            img.onload = () => {
              canvas.width = width;
              canvas.height = height;
              ctx.fillStyle = "white"; 
              ctx.fillRect(0, 0, width, height);
              ctx.drawImage(img, 0, 0);
              const a = document.createElement("a");
              a.download = `Grafico_${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;
              a.href = canvas.toDataURL("image/png");
              a.click();
            };
            img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgData)));
          };

          const formatY = (val) => isTma ? `${Math.round(val)}h` : Math.round(val);

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
              <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-3xl relative">
                <div className="flex justify-between items-start mb-6 pr-6">
                  <div>
                     <h3 className="text-xl font-bold text-gray-800 mb-2 truncate">{title}</h3>
                     <div className="flex gap-4 text-xs text-gray-500 font-medium">
                       <span className="flex items-center gap-1.5"><div className="w-3 h-3 bg-[#064e3b] rounded-sm"></div> Bom (Dentro da Meta)</span>
                       <span className="flex items-center gap-1.5"><div className="w-3 h-3 bg-[#7f1d1d] rounded-sm"></div> Ruim (Fora da Meta)</span>
                       <span className="bg-gray-100 px-2 py-0.5 rounded text-gray-700">Meta: {target} {isTma ? 'Horas' : ''}</span>
                     </div>
                  </div>
                  <button onClick={exportChart} className="shrink-0 text-sm bg-blue-50 hover:bg-blue-100 text-blue-600 px-4 py-2 rounded-lg flex items-center gap-2 font-bold transition-colors border border-blue-200 shadow-sm">
                      <i className="fas fa-download"></i> Exportar Gráfico
                  </button>
                </div>

                <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition-colors">
                    <i className="fas fa-times w-5 h-5 flex items-center justify-center"></i>
                </button>

                <div className="flex justify-center bg-gray-50/50 rounded-xl p-4 border border-gray-100">
                  <svg ref={svgRef} xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox={`0 0 ${width} ${height}`} className="w-full h-auto overflow-visible bg-white rounded">
                    <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#e5e7eb" strokeWidth="1.5" />
                    <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#e5e7eb" strokeWidth="1.5" />
                    
                    {[0, maxY/2, maxY].map(val => (
                      <g key={val}>
                        <line x1={padding} y1={getY(val)} x2={width - padding} y2={getY(val)} stroke="#f3f4f6" strokeDasharray="4" />
                        <text x={padding - 10} y={getY(val) + 4} textAnchor="end" fontSize="11" fontFamily="sans-serif" fill="#9ca3af" fontWeight="bold">{formatY(val)}</text>
                      </g>
                    ))}

                    <line x1={padding} y1={getY(target)} x2={width - padding} y2={getY(target)} stroke="#ca8a04" strokeWidth="2" strokeDasharray="5" />
                    <text x={padding - 10} y={getY(target) + 15} textAnchor="end" fill="#ca8a04" fontSize="10" fontFamily="sans-serif" fontWeight="bold">Meta</text>

                    {chartType === 'bar' && validData.map((val, i) => {
                      const isGood = lowerIsBetter ? val <= target : val >= target;
                      const color = isGood ? '#064e3b' : '#7f1d1d';
                      const barH = ((val / maxY) * graphHeight);
                      return (
                        <g key={i}>
                          <rect x={getX(i) - 12} y={getY(val)} width={24} height={barH} fill={color} opacity="0.9" rx="3"/>
                          <text x={getX(i)} y={height - padding + 20} textAnchor="middle" fontSize="11" fontFamily="sans-serif" fill="#6b7280" fontWeight="bold">{MONTHS[i]}</text>
                        </g>
                      )
                    })}

                    {chartType === 'line' && (
                      <>
                        <path d={validData.reduce((acc, val, i) => `${acc} ${i === 0 ? 'M' : 'L'} ${getX(i)} ${getY(val)}`, "")} fill="none" stroke="#9ca3af" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" />
                        {validData.map((val, i) => {
                           const isGood = lowerIsBetter ? val <= target : val >= target;
                           const color = isGood ? '#064e3b' : '#7f1d1d';
                           return (
                             <g key={i}>
                               <circle cx={getX(i)} cy={getY(val)} r="5" fill={color} stroke="white" strokeWidth="2" />
                               <text x={getX(i)} y={height - padding + 20} textAnchor="middle" fontSize="11" fontFamily="sans-serif" fill="#6b7280" fontWeight="bold">{MONTHS[i]}</text>
                             </g>
                           )
                        })}
                      </>
                    )}
                  </svg>
                </div>
              </div>
            </div>
          );
        };


        // ==========================================
        // 5. MÓDULOS PRINCIPAIS
        // ==========================================
        const ProjectsModule = ({ user }) => {
          const [projects, setProjects] = useState([]);
          const [filter, setFilter] = useState('Todos');
          const [loading, setLoading] = useState(true);
          const [deleteId, setDeleteId] = useState(null);
          const [showAlertModal, setShowAlertModal] = useState(false);
          const [alertData, setAlertData] = useState({ bruno: [], renata: [] });
          const fileInputRef = useRef(null);
          
          const [colWidths, setColWidths] = useState(() => JSON.parse(localStorage.getItem('govProjectsColWidths')) || { process: 200, action: 300, owner: 150, area: 150, criticality: 120, status: 140, dates: 160, sla: 80, remaining: 100, notes: 250, actions: 80 });
          const [rowDensity, setRowDensity] = useState(() => localStorage.getItem('govProjectsRowDensity') || 'normal');
          const [resizingCol, setResizingCol] = useState(null);
          const resizeStartX = useRef(null);

          useEffect(() => localStorage.setItem('govProjectsColWidths', JSON.stringify(colWidths)), [colWidths]);
          useEffect(() => localStorage.setItem('govProjectsRowDensity', rowDensity), [rowDensity]);

          useEffect(() => {
            if (!user) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'gov_projects'), orderBy('displayId'));
            return onSnapshot(q, async (snapshot) => {
              if (snapshot.empty) {
                const batch = writeBatch(db);
                const initialProjectsTemplate = [
                  { displayId: 1, process: "Gestão de Nível de Serviço", action: "Padronização das áreas referentes aos SLA's", owner: "A definir", area: "Governança CSC", criticality: "Alta", status: "Não Iniciado", startDate: "", endDate: "", sla: 30, notes: "Definir catálogo de serviços padrão." },
                  { displayId: 2, process: "Monitoramento e Qualidade", action: "Automatizar apuração da aderência de monitoramento", owner: "A definir", area: "Governança CSC", criticality: "Média", status: "Não Iniciado", startDate: "", endDate: "", sla: 45, notes: "Atualmente feito de forma manual." },
                ];
                initialProjectsTemplate.forEach(p => batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'gov_projects')), p));
                await batch.commit(); return;
              }
              setProjects(snapshot.docs.map(d => ({ ...d.data(), id: d.id })));
              setLoading(false);
            });
          }, [user]);

          const updateField = (id, field, val) => user && updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gov_projects', id), { [field]: val });
          const addProject = () => user && addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'gov_projects'), { displayId: Date.now(), process: "Novo", action: "", owner: "", area: "", criticality: "Baixa", status: "Não Iniciado", startDate: "", endDate: "", sla: 0, notes: "" });
          const confirmDelete = () => user && deleteId && deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gov_projects', deleteId)).then(() => setDeleteId(null));
          
          const sendToKanban = async (p) => {
            if (!user) return;
            try {
              await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'kanban_board_tasks'), {
                text: `[Projeto] ${p.process}\nAção: ${p.action}\nDono: ${p.owner || 'Não definido'}`,
                status: "A Iniciar",
                createdAt: Date.now()
              });
              alert(`O projeto "${p.process}" foi enviado para a coluna 'A Iniciar' do seu Quadro Kanban!`);
            } catch (err) {
              console.error("Erro ao enviar para o kanban", err);
              alert("Erro ao enviar o projeto para o Kanban.");
            }
          };

          useEffect(() => {
            const move = (e) => resizingCol && setColWidths(p => ({ ...p, [resizingCol]: Math.max(50, p[resizingCol] + (e.pageX - resizeStartX.current)) }));
            const up = () => { setResizingCol(null); resizeStartX.current = null; };
            if (resizingCol) { window.addEventListener('mousemove', move); window.addEventListener('mouseup', up); }
            return () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
          }, [resizingCol]);

          const startResize = (e, col) => { e.preventDefault(); setResizingCol(col); resizeStartX.current = e.pageX; };
          const ResizableHeader = ({ label, colKey }) => (
            <th className="px-4 py-3 relative bg-white/90 text-gray-700 uppercase font-bold text-xs border-b border-gray-200 select-none group" style={{ width: colWidths[colKey] }}>
              <span className="truncate block">{label}</span>
              <div className="absolute right-0 top-0 h-full w-1 cursor-col-resize hover:bg-blue-500 group-hover:bg-gray-300 transition-colors" onMouseDown={(e) => startResize(e, colKey)} />
            </th>
          );

          const getDays = (date) => date ? Math.ceil((new Date(date) - new Date()) / 86400000) : null;
          const filtered = filter === 'Todos' ? projects : projects.filter(p => p.status === filter);
          const pad = rowDensity === 'compact' ? 'py-1' : rowDensity === 'spacious' ? 'py-4' : 'py-2';

          const exportToCSV = () => {
            const headers = ["Processo", "Ação", "Dono", "Área", "Criticidade", "Status", "Data Início", "Data Fim", "SLA", "Observações"];
            const rows = projects.map(p => [p.process, p.action, p.owner, p.area, p.criticality, p.status, p.startDate, p.endDate, p.sla, p.notes].map(f => `"${f || ''}"`).join(","));
            const blob = new Blob(["\uFEFF" + [headers.join(","), ...rows].join("\n")], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Projetos_Gov_CSC_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
          };

          const importFromCSV = (e) => {
            const file = e.target.files[0];
            if (!file || !user) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
              const lines = e.target.result.split(/\r\n|\n/).filter(l => l.trim());
              if (lines.length < 2) return;
              const batch = writeBatch(db);
              for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                if (cols.length < 5) continue;
                batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'gov_projects')), {
                  displayId: Date.now() + i, process: cols[0], action: cols[1], owner: cols[2], area: cols[3], criticality: cols[4] || "Baixa", status: cols[5] || "Não Iniciado", startDate: cols[6], endDate: cols[7], sla: Number(cols[8]) || 0, notes: cols[9]
                });
              }
              await batch.commit();
              alert("Dados importados com sucesso!");
            };
            reader.readAsText(file);
          };

          const handleEmailAlert = () => {
            const brunoProjects = [];
            const renataProjects = [];

            projects.forEach(p => {
              if (p.status === 'Concluído') return;
              const days = getDays(p.endDate);
              if (days === null) return;

              if (days === 10 || days === 5 || days < 0) {
                const ownerLower = (p.owner || '').toLowerCase();
                if (ownerLower.includes('bruno')) brunoProjects.push(p);
                if (ownerLower.includes('renata')) renataProjects.push(p);
              }
            });

            if (brunoProjects.length === 0 && renataProjects.length === 0) {
              alert("Nenhum projeto de Bruno ou Renata está faltando exatamente 10 dias, 5 dias para vencer, ou atrasado no momento.");
              return;
            }

            setAlertData({ bruno: brunoProjects, renata: renataProjects });
            setShowAlertModal(true);
          };

          const sendSpecificEmail = (ownerName, email, projectList) => {
            let body = `Olá ${ownerName},\n\nSegue resumo dos seus projetos com prazo crítico (faltando 10 ou 5 dias, ou atrasados):\n\n`;
            projectList.forEach(p => {
              const days = getDays(p.endDate);
              const statusText = days < 0 ? `ATRASADO (${Math.abs(days)} dias)` : `Vence em ${days} dias`;
              body += `• [${p.process}] ${p.action}\n  Status: ${statusText}\n\n`;
            });
            body += "Atenciosamente,\nCélula de Desempenho Governança CSC";
            
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(`ALERTA: Prazos de Projetos - ${ownerName}`)}&body=${encodeURIComponent(body)}`;
          };

          return (
            <div className="bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-white/40 flex flex-col h-full animate-in fade-in zoom-in duration-300">
              {deleteId && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                  <div className="bg-white rounded-lg p-6 max-w-sm w-full shadow-2xl">
                    <h3 className="font-bold text-lg mb-2 text-gray-800">Excluir Projeto?</h3>
                    <p className="text-sm text-gray-600 mb-4">Esta ação é irreversível.</p>
                    <div className="flex justify-end gap-2 mt-4">
                      <button onClick={() => setDeleteId(null)} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded transition-colors">Cancelar</button>
                      <button onClick={confirmDelete} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition-colors flex items-center gap-2"><i className="fas fa-trash"></i> Excluir</button>
                    </div>
                  </div>
                </div>
              )}

              {showAlertModal && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                  <div className="bg-white rounded-lg p-6 max-w-md w-full shadow-2xl">
                    <h3 className="font-bold text-lg mb-4 text-gray-800">Enviar Alertas de E-mail</h3>
                    <p className="text-sm text-gray-600 mb-4">Projetos críticos encontrados (10 dias, 5 dias ou atrasados):</p>
                    <div className="space-y-4">
                      {alertData.bruno.length > 0 && (
                        <div className="flex justify-between items-center bg-gray-50 p-3 rounded border border-gray-200">
                          <div>
                            <p className="font-bold text-gray-800">Bruno Augusto</p>
                            <p className="text-xs text-gray-500">{alertData.bruno.length} projeto(s)</p>
                          </div>
                          <button onClick={() => sendSpecificEmail('Bruno', 'bruno.augusto@equatorialenergia.com.br', alertData.bruno)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm flex items-center gap-2 transition-colors">
                            <i className="fas fa-paper-plane"></i> E-mail
                          </button>
                        </div>
                      )}
                      {alertData.renata.length > 0 && (
                        <div className="flex justify-between items-center bg-gray-50 p-3 rounded border border-gray-200">
                          <div>
                            <p className="font-bold text-gray-800">Renata Tavares</p>
                            <p className="text-xs text-gray-500">{alertData.renata.length} projeto(s)</p>
                          </div>
                          <button onClick={() => sendSpecificEmail('Renata', 'renata.tavares@equatorialenergia.com.br', alertData.renata)} className="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded text-sm flex items-center gap-2 transition-colors">
                            <i className="fas fa-paper-plane"></i> E-mail
                          </button>
                        </div>
                      )}
                    </div>
                    <div className="mt-6 flex justify-end">
                      <button onClick={() => setShowAlertModal(false)} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded transition-colors text-sm font-medium">Fechar</button>
                    </div>
                  </div>
                </div>
              )}
              
              <input type="file" accept=".csv" ref={fileInputRef} onChange={importFromCSV} className="hidden" />

              <div className="p-4 border-b border-gray-200 flex flex-col xl:flex-row justify-between items-center gap-4 bg-white/50">
                <div className="flex gap-2 bg-gray-100 p-1 rounded-lg">
                  {['Todos', 'Em Andamento', 'Não Iniciado', 'Concluído'].map(st => (
                    <button key={st} onClick={() => setFilter(st)} className={`px-4 py-1.5 text-xs font-medium rounded-md transition-all ${filter === st ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}>{st}</button>
                  ))}
                </div>
                <div className="flex flex-wrap items-center gap-2">
                   <div className="flex bg-gray-100 rounded-lg p-1 mr-2 border border-gray-200">
                     <button onClick={() => setRowDensity('compact')} className={`p-1.5 rounded transition-colors ${rowDensity==='compact'?'bg-white shadow text-blue-600':'text-gray-400 hover:text-gray-600'}`} title="Compacto"><i className="fas fa-align-justify"></i></button>
                     <button onClick={() => setRowDensity('normal')} className={`p-1.5 rounded transition-colors ${rowDensity==='normal'?'bg-white shadow text-blue-600':'text-gray-400 hover:text-gray-600'}`} title="Normal"><i className="fas fa-align-center"></i></button>
                     <button onClick={() => setRowDensity('spacious')} className={`p-1.5 rounded transition-colors ${rowDensity==='spacious'?'bg-white shadow text-blue-600':'text-gray-400 hover:text-gray-600'}`} title="Amplo"><i className="fas fa-arrows-alt-v"></i></button>
                   </div>
                   <button onClick={addProject} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm"><i className="fas fa-plus"></i> Novo</button>
                   <button onClick={exportToCSV} className="flex items-center gap-2 bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors shadow-sm"><i className="fas fa-download"></i> Exportar</button>
                   <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors shadow-sm"><i className="fas fa-upload"></i> Importar</button>
                   <button onClick={handleEmailAlert} className="flex items-center gap-2 bg-amber-50 border border-amber-200 text-amber-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-amber-100 transition-colors shadow-sm"><i className="fas fa-envelope"></i> Alerta</button>
                </div>
              </div>

              <div className="flex-1 overflow-auto">
                <table className="min-w-full text-sm text-left table-fixed">
                  <thead className="sticky top-0 z-10 shadow-sm bg-gray-50">
                    <tr>
                      <ResizableHeader label="Processo" colKey="process" />
                      <ResizableHeader label="Ação / Projeto" colKey="action" />
                      <ResizableHeader label="Dono" colKey="owner" />
                      <ResizableHeader label="Área" colKey="area" />
                      <ResizableHeader label="Criticidade" colKey="criticality" />
                      <ResizableHeader label="Status" colKey="status" />
                      <ResizableHeader label="Datas" colKey="dates" />
                      <ResizableHeader label="SLA (dias)" colKey="sla" />
                      <ResizableHeader label="Restante" colKey="remaining" />
                      <ResizableHeader label="Observações" colKey="notes" />
                      <th className="w-[80px] bg-white/90 border-b border-gray-200"></th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-100 bg-white/50">
                    {loading ? <tr><td colSpan="11" className="p-10 text-center"><i className="fas fa-spinner fa-spin text-blue-500 text-3xl"></i></td></tr> : filtered.map(p => {
                      const d = getDays(p.endDate);
                      const color = d === null ? 'text-gray-400' : d < 0 ? 'text-red-600 font-bold bg-red-50 px-2 py-0.5 rounded-full' : d < 5 ? 'text-amber-600 font-bold' : 'text-green-600 font-bold';
                      return (
                        <tr key={p.id} className="hover:bg-blue-50/50 transition-colors group">
                          <td className={`px-4 ${pad}`}><textarea value={p.process} onChange={e=>updateField(p.id,'process',e.target.value)} className="w-full bg-transparent resize-none focus:bg-white focus:shadow-sm focus:ring-1 focus:ring-blue-200 rounded p-1 text-gray-700 font-medium" rows={rowDensity === 'compact' ? 1 : 2}/></td>
                          <td className={`px-4 ${pad}`}><textarea value={p.action} onChange={e=>updateField(p.id,'action',e.target.value)} className="w-full bg-transparent resize-none focus:bg-white focus:shadow-sm focus:ring-1 focus:ring-blue-200 rounded p-1 text-gray-600" rows={rowDensity === 'compact' ? 1 : 2}/></td>
                          <td className={`px-4 ${pad}`}><input value={p.owner} onChange={e=>updateField(p.id,'owner',e.target.value)} className="w-full bg-transparent focus:bg-white focus:shadow-sm focus:ring-1 focus:ring-blue-200 rounded p-1 text-gray-600"/></td>
                          <td className={`px-4 ${pad}`}><input value={p.area} onChange={e=>updateField(p.id,'area',e.target.value)} className="w-full bg-transparent focus:bg-white focus:shadow-sm focus:ring-1 focus:ring-blue-200 rounded p-1 text-gray-600"/></td>
                          <td className={`px-4 ${pad}`}>
                            <select value={p.criticality} onChange={e=>updateField(p.id,'criticality',e.target.value)} className={`bg-transparent w-full text-xs font-semibold rounded p-1 ${p.criticality==='Alta'?'text-red-700 bg-red-50':p.criticality==='Média'?'text-amber-700 bg-amber-50':'text-green-700 bg-green-50'}`}>
                              <option value="Alta">Alta</option><option value="Média">Média</option><option value="Baixa">Baixa</option>
                            </select>
                          </td>
                          <td className={`px-4 ${pad}`}>
                            <select value={p.status} onChange={e=>updateField(p.id,'status',e.target.value)} className="bg-transparent w-full text-xs rounded p-1 border border-transparent focus:border-blue-300 focus:bg-white"><option>Não Iniciado</option><option>Planejado</option><option>Em Andamento</option><option>Atrasado</option><option>Concluído</option></select>
                          </td>
                          <td className={`px-4 ${pad}`}>
                            <div className="flex flex-col gap-1">
                              <div className="flex items-center gap-1 text-[10px] text-gray-400"><span className="w-6">Ini:</span><input type="date" value={p.startDate} onChange={e=>updateField(p.id,'startDate',e.target.value)} className="bg-transparent text-gray-600 font-medium focus:outline-none"/></div>
                              <div className="flex items-center gap-1 text-[10px] text-gray-400"><span className="w-6">Fim:</span><input type="date" value={p.endDate} onChange={e=>updateField(p.id,'endDate',e.target.value)} className="bg-transparent text-gray-800 font-bold focus:outline-none"/></div>
                            </div>
                          </td>
                          <td className={`px-4 ${pad} text-center`}><input type="number" value={p.sla} onChange={e=>updateField(p.id,'sla',e.target.value)} className="w-12 text-center bg-transparent border-b border-gray-100 hover:border-gray-300 focus:border-blue-500 focus:outline-none"/></td>
                          <td className={`px-4 ${pad} text-center text-xs`}><span className={color}>{d !== null ? `${d} d` : '-'}</span></td>
                          <td className={`px-4 ${pad}`}><textarea value={p.notes} onChange={e=>updateField(p.id,'notes',e.target.value)} className="w-full bg-transparent resize-none focus:bg-white focus:shadow-sm focus:ring-1 focus:ring-blue-200 rounded p-1 text-xs text-gray-500" rows={rowDensity === 'compact' ? 1 : 2} placeholder="Obs..."/></td>
                          <td className={`px-4 ${pad} text-center flex items-center justify-center gap-2 h-full min-h-[40px]`}>
                            <button onClick={() => sendToKanban(p)} title="Adicionar ao Kanban" className="text-indigo-400 hover:text-indigo-600 transition-colors p-1.5 rounded-full hover:bg-indigo-50"><i className="fas fa-tasks"></i></button>
                            <button onClick={()=>setDeleteId(p.id)} title="Excluir Projeto" className="text-gray-300 hover:text-red-600 transition-colors p-1.5 rounded-full hover:bg-red-50"><i className="fas fa-trash"></i></button>
                          </td>
                        </tr>
                      )
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          );
        }

        const DirectorateSummaryTable = ({ user }) => {
          const [summaryData, setSummaryData] = useState([]);
          const [loading, setLoading] = useState(true);
          const [searchTerm, setSearchTerm] = useState("");
          const [selectedIndicator, setSelectedIndicator] = useState(null);
          const [colWidths, setColWidths] = useState(() => JSON.parse(localStorage.getItem('dirSummaryColWidths')) || { 
            name: 350, ...MONTHS.reduce((acc, m) => ({...acc, [m]: 160}), {}) 
          });
          const [resizingCol, setResizingCol] = useState(null);
          const resizeStartX = useRef(null);
          useEffect(() => localStorage.setItem('dirSummaryColWidths', JSON.stringify(colWidths)), [colWidths]);

          useEffect(() => {
            if (!user) return;
            const fetchAllData = async () => {
              try {
                const collections = ['dir_result_nivel_servico_v3_fixed', 'dir_sla_specific_v2_clean', 'dir_backlog_v1_fixed'];
                const dataMap = new Map();
                
                for (const colName of collections) {
                  const snapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', colName));
                  snapshot.forEach(doc => {
                    const data = doc.data();
                    dataMap.set(data.name.toUpperCase().trim(), data);
                  });
                }
                
                const mergedData = RT_GOV_ITEMS.map((name, index) => {
                  const source = dataMap.get(name.toUpperCase().trim());
                  if (source) {
                    return { ...source, name: name, order: index }; 
                  } else {
                     return {
                        name: name,
                        target: 95.0, type: "percent", direction: "max", weight: 1, order: index,
                        months: Array.from({length: 12}, () => ({ falseVal: null, trueVal: null, real: null, acum: null }))
                     };
                  }
                });
                setSummaryData(mergedData);
                setLoading(false);
              } catch (err) {
                console.error("Error fetching summary data", err);
                setLoading(false);
              }
            };
            fetchAllData();
          }, [user]);

          useEffect(() => {
            const move = (e) => resizingCol && setColWidths(p => ({ ...p, [resizingCol]: Math.max(50, p[resizingCol] + (e.pageX - resizeStartX.current)) }));
            const up = () => { setResizingCol(null); resizeStartX.current = null; };
            if (resizingCol) { window.addEventListener('mousemove', move); window.addEventListener('mouseup', up); }
            return () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
          }, [resizingCol]);

          const startResize = (e, col) => { e.preventDefault(); setResizingCol(col); resizeStartX.current = e.pageX; };
          const ResizableHeader = ({ label, colKey, className }) => (
            <th className={`p-2 text-center font-bold border-b border-r border-gray-300 relative select-none group ${className}`} style={{ width: colWidths[colKey] }}>
              <span className="truncate block w-full">{label}</span>
              <div className="absolute right-0 top-0 h-full w-1 cursor-col-resize hover:bg-blue-500 group-hover:bg-gray-300 transition-colors z-30" onMouseDown={(e) => startResize(e, colKey)} />
            </th>
          );
          
          const filteredData = summaryData.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()));

          if (loading) return <div className="flex flex-col items-center justify-center h-full gap-4 text-white"><i className="fas fa-spinner fa-spin text-4xl"></i><p>Compilando dados de Governança...</p></div>;

          return (
            <div className="bg-white/95 backdrop-blur-md rounded-lg shadow-xl border border-white/50 flex flex-col h-full animate-in slide-in-from-bottom-4 duration-500 overflow-hidden relative">
              {selectedIndicator && <IndicatorChartModal indicator={selectedIndicator} onClose={() => setSelectedIndicator(null)} />}
              <div className="p-4 border-b border-gray-200 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4 z-20">
                <div>
                  <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><i className="fas fa-clipboard-list text-purple-600"></i> RT Governança 2026</h2>
                  <p className="text-xs text-gray-500 mt-1">Consolidado ({summaryData.length} Indicadores) | Espelho das Subseções</p>
                </div>
                <div className="relative w-64"><i className="fas fa-filter absolute left-3 top-3 text-gray-400"></i><input type="text" placeholder="Filtrar..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-4 py-2 text-sm border border-gray-300 rounded-lg"/></div>
              </div>
              <div className="flex-1 overflow-auto bg-gray-100 p-4">
                <div className="bg-white rounded-lg shadow border border-gray-300 overflow-hidden h-full flex flex-col relative">
                  <div className="overflow-auto flex-1 pb-2">
                    <table className="min-w-max text-xs border-collapse">
                      <thead className="bg-gray-200 text-gray-700 sticky top-0 z-20 shadow-md">
                        <tr>
                           <th className="p-3 text-left font-bold border-b border-gray-300 w-96 sticky left-0 bg-gray-200 z-30 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.2)]" style={{ width: colWidths.name }}>
                            Indicador Consolidado
                            <div className="absolute right-0 top-0 h-full w-1 cursor-col-resize hover:bg-blue-500 z-40" onMouseDown={(e) => startResize(e, 'name')} />
                          </th>
                          {MONTHS.map(m => (
                            <ResizableHeader key={m} label={
                              <>
                                 {m}
                                 <div className="flex text-[9px] font-normal text-gray-500 mt-1 border-t border-gray-300 pt-1">
                                   <span className="w-1/4 text-center border-r border-gray-200">F/Pz</span>
                                   <span className="w-1/4 text-center border-r border-gray-200">T/Tot</span>
                                   <span className="w-1/4 text-center font-bold text-blue-700 border-r border-gray-200">Real</span>
                                   <span className="w-1/4 text-center font-bold text-gray-700">Acum</span>
                                 </div>
                              </>
                            } colKey={m} className="min-w-[160px] bg-gray-100" />
                          ))}
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {filteredData.map((ind, idx) => (
                           <tr key={idx} className={`hover:bg-blue-50 transition-colors ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50/30'}`}>
                              <td className="p-0 border-r border-gray-200 sticky left-0 z-10 bg-inherit shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] cursor-pointer group/name hover:bg-blue-50" title={`Ver gráfico de ${ind.name}`} onClick={() => setSelectedIndicator(ind)}>
                                 <div className="flex justify-between items-center w-full h-full px-2 py-2 font-medium text-gray-700 group-hover/name:text-blue-600 transition-colors">
                                    <span className="truncate max-w-[90%]">{ind.name}</span>
                                    <i className="fas fa-chart-line text-blue-400 opacity-0 group-hover/name:opacity-100 transition-opacity"></i>
                                 </div>
                              </td>
                              {ind.months.map((m, mIdx) => {
                                 let realBg = "bg-gray-50 text-gray-300"; let realText = "-";
                                 if (m.real !== null) { 
                                   const hit = ind.direction === 'min' ? m.real <= ind.target : m.real >= ind.target;
                                   realBg = hit ? "bg-green-100 text-green-700" : "bg-red-100 text-red-700"; 
                                   realText = m.real + (ind.type === 'percent' ? '%' : ''); 
                                 }
                                 let acumBg = "bg-gray-100 text-gray-300"; let acumText = "-";
                                 if (m.acum !== null) {
                                    const hit = ind.direction === 'min' ? m.acum <= ind.target : m.acum >= ind.target;
                                    acumBg = hit ? "bg-green-200 text-green-900" : "bg-red-200 text-red-900";
                                    acumText = m.acum + (ind.type === 'percent' ? '%' : '');
                                 }
                                 return (
                                    <td key={mIdx} className="p-0 border-r border-gray-200 min-w-[160px]">
                                       <div className="flex items-stretch h-full min-h-[32px]">
                                          <div className="w-1/4 flex items-center justify-center text-[10px] border-r border-gray-100 bg-white text-gray-400">{m.falseVal ?? '-'}</div>
                                          <div className="w-1/4 flex items-center justify-center text-[10px] border-r border-gray-100 bg-white text-gray-400">{m.trueVal ?? '-'}</div>
                                          <div className={`w-1/4 flex items-center justify-center text-[9px] font-bold border-r border-white ${realBg}`}>{realText}</div>
                                          <div className={`w-1/4 flex items-center justify-center text-[9px] font-bold ${acumBg}`}>{acumText}</div>
                                       </div>
                                    </td>
                                 )
                              })}
                           </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div className="bg-white border-t border-gray-200 p-2 px-4 text-xs text-gray-500 italic">
                * Esta tabela espelha automaticamente os dados das abas "Result. Nível Serviço", "Painel SLA" e "Backlog". Para editar, acesse a aba de origem.
              </div>
            </div>
          );
        };

        const DynamicTable = ({ user, collectionName, title, subtitle, generator, showWeight = true, inputLabels = { f: "F (Ok)", t: "T (Nok)" }, calculationType = "sla", headerColor = "bg-gray-200" }) => {
          const [indicators, setIndicators] = useState([]);
          const [loading, setLoading] = useState(true);
          const [searchTerm, setSearchTerm] = useState("");
          const [selectedIndicator, setSelectedIndicator] = useState(null);
          const fileInputRef = useRef(null);
          
          const [colWidths, setColWidths] = useState(() => JSON.parse(localStorage.getItem(`cols_${collectionName}`)) || { 
            name: 350, weight: 60, ...MONTHS.reduce((acc, m) => ({...acc, [m]: 160}), {}) 
          });
          const [rowDensity, setRowDensity] = useState('normal');
          const [resizingCol, setResizingCol] = useState(null);
          const resizeStartX = useRef(null);

          useEffect(() => localStorage.setItem(`cols_${collectionName}`, JSON.stringify(colWidths)), [colWidths]);

          useEffect(() => {
            if (!user) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', collectionName), orderBy('order'));
            const unsubscribe = onSnapshot(q, async (snapshot) => {
              if (snapshot.empty) {
                const initialData = generator();
                const batch = writeBatch(db);
                initialData.forEach((ind) => {
                  const docRef = doc(collection(db, 'artifacts', appId, 'public', 'data', collectionName));
                  batch.set(docRef, ind);
                });
                await batch.commit(); return;
              }
              setIndicators(snapshot.docs.map(d => ({ ...d.data(), id: d.id })));
              setLoading(false);
            });
            return () => unsubscribe();
          }, [user, collectionName]);

          const updateIndicatorMeta = async (indId, field, value) => {
            if (!user) return;
            const indIndex = indicators.findIndex(i => i.id === indId);
            const updatedInd = { ...indicators[indIndex], [field]: value };
            const newIndicators = [...indicators]; newIndicators[indIndex] = updatedInd; setIndicators(newIndicators);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, indId), { [field]: value });
          };

          const updateValues = async (indId, monthIdx, field, value) => {
            if (!user) return;
            const indIndex = indicators.findIndex(i => i.id === indId);
            const ind = indicators[indIndex];
            const newMonths = [...ind.months];
            
            const numVal = value === '' ? null : parseFloat(value); 
            newMonths[monthIdx][field] = numVal;

            if (calculationType === "backlog") {
               const total = newMonths[monthIdx].trueVal;
               newMonths[monthIdx].real = total !== null ? total : 0;
            } else {
               const f = newMonths[monthIdx].falseVal; 
               const t = newMonths[monthIdx].trueVal;  
               if (f !== null && t !== null) {
                 const total = f + t;
                 newMonths[monthIdx].real = total > 0 ? parseFloat(((f / total) * 100).toFixed(2)) : 0;
               } else if (f !== null && t === null) { newMonths[monthIdx].real = 100.00; } else if (t !== null && f === null) { newMonths[monthIdx].real = 0.00; }
            }

            let sum = 0, count = 0;
            for (let i = 0; i <= 11; i++) { 
               if (newMonths[i].real !== null && !isNaN(newMonths[i].real)) { sum += newMonths[i].real; count++; }
            }
            newMonths[monthIdx].acum = count > 0 ? parseFloat((sum / count).toFixed(2)) : null;

            const newIndicators = [...indicators]; newIndicators[indIndex] = { ...ind, months: newMonths }; setIndicators(newIndicators);
            
            if (collectionName === "dir_result_nivel_servico_v3_fixed") {
                if (!ind.isMain) {
                    let parentIndex = -1;
                    for(let i = indIndex; i >= 0; i--) {
                        if (indicators[i].isMain) {
                            parentIndex = i;
                            break;
                        }
                    }
                    
                    if (parentIndex !== -1) {
                        const parent = indicators[parentIndex];
                        const children = [];
                        for(let i = parentIndex + 1; i < indicators.length; i++) {
                            if (indicators[i].isMain) break;
                            children.push(i === indIndex ? { ...ind, months: newMonths } : indicators[i]); 
                        }
                        
                        const parentMonths = [...parent.months];
                        for(let m = 0; m < 12; m++) {
                            let sumF = 0;
                            let sumT = 0;
                            let hasData = false;
                            
                            children.forEach(child => {
                                const childM = child.months[m];
                                if (childM.falseVal !== null && childM.trueVal !== null) {
                                    sumF += childM.falseVal;
                                    sumT += childM.trueVal;
                                    hasData = true;
                                }
                            });
                            
                            if (hasData) {
                                parentMonths[m].falseVal = sumF;
                                parentMonths[m].trueVal = sumT;
                                const total = sumF + sumT;
                                parentMonths[m].real = total > 0 ? parseFloat(((sumF / total) * 100).toFixed(2)) : 0;
                            } 
                        }
                        newIndicators[parentIndex] = { ...parent, months: parentMonths };
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, parent.id), { months: parentMonths });
                    }
                }
            }

            setIndicators(newIndicators);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, indId), { months: newMonths });
          };

          const addIndicator = async () => {
            if (!user) return;
            const newOrder = indicators.length > 0 ? Math.max(...indicators.map(i => i.order || 0)) + 1 : 0;
            const newInd = {
              name: "Novo Indicador",
              target: 95.0, weight: 1, type: "percent", direction: "max", isMain: false, order: newOrder,
              months: Array.from({length: 12}, () => ({ falseVal: null, trueVal: null, real: null, acum: null }))
            };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', collectionName), newInd);
          };

          const deleteIndicator = async (id) => {
            if (!user || !confirm("Deseja excluir este indicador?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, id));
          };

          const filteredIndicators = indicators.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()));

          useEffect(() => {
            const move = (e) => resizingCol && setColWidths(p => ({ ...p, [resizingCol]: Math.max(50, p[resizingCol] + (e.pageX - resizeStartX.current)) }));
            const up = () => { setResizingCol(null); resizeStartX.current = null; };
            if (resizingCol) { window.addEventListener('mousemove', move); window.addEventListener('mouseup', up); }
            return () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
          }, [resizingCol]);

          const startResize = (e, col) => { e.preventDefault(); setResizingCol(col); resizeStartX.current = e.pageX; };
          const ResizableHeader = ({ label, colKey, className }) => (
            <th className={`p-2 text-center font-bold border-b border-r border-gray-300 relative select-none group ${className}`} style={{ width: colWidths[colKey] }}>
              <span className="truncate block w-full">{label}</span>
              <div className="absolute right-0 top-0 h-full w-1 cursor-col-resize hover:bg-blue-500 group-hover:bg-gray-300 transition-colors z-30" onMouseDown={(e) => startResize(e, colKey)} />
            </th>
          );

          const pad = rowDensity === 'compact' ? 'py-1' : rowDensity === 'spacious' ? 'py-3' : 'py-2';

          if (loading) return <div className="flex flex-col items-center justify-center h-full gap-4 text-white"><i className="fas fa-spinner fa-spin text-4xl"></i><p>Carregando {title}...</p></div>;

          return (
            <div className={`backdrop-blur-md rounded-lg shadow-xl border border-white/50 flex flex-col h-full animate-in slide-in-from-bottom-4 duration-500 overflow-hidden relative ${collectionName.includes('gov') ? 'bg-blue-50/90' : 'bg-white/95'}`}>
              {selectedIndicator && <IndicatorChartModal indicator={selectedIndicator} onClose={() => setSelectedIndicator(null)} />}
              
              <div className="p-4 border-b border-gray-200 bg-white/50 flex flex-col sm:flex-row justify-between items-center gap-4 z-20">
                <div>
                  <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><i className="fas fa-wave-square text-blue-600"></i> {title}</h2>
                  <p className="text-xs text-gray-500 mt-1">{subtitle} ({indicators.length} Indicadores)</p>
                </div>
                <div className="flex items-center gap-3">
                    <button onClick={addIndicator} className="flex items-center gap-2 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 shadow text-xs font-medium"><i className="fas fa-plus"></i> Adicionar</button>
                </div>
              </div>

              <div className="flex-1 overflow-auto bg-gray-100 p-4">
                <div className="bg-white rounded-lg shadow border border-gray-300 overflow-hidden h-full flex flex-col relative">
                  <div className="overflow-auto flex-1 pb-2"> 
                    <table className="min-w-max text-xs border-collapse">
                      <thead className={`${headerColor} text-gray-700 sticky top-0 z-20 shadow-md`}>
                        <tr>
                          <th className="p-3 text-left font-bold border-b border-gray-300 w-96 sticky left-0 z-30 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.2)] bg-inherit" style={{ width: colWidths.name }}>
                            Indicador
                            <div className="absolute right-0 top-0 h-full w-1 cursor-col-resize hover:bg-blue-500 z-40" onMouseDown={(e) => startResize(e, 'name')} />
                          </th>
                          {showWeight && <ResizableHeader label="Peso" colKey="weight" className="w-14 bg-inherit" />}
                          {MONTHS.map(m => (
                            <ResizableHeader key={m} label={
                              <>
                                {m}
                                <div className="flex text-[9px] font-normal text-gray-500 mt-1 border-t border-gray-300 pt-1">
                                  <span className="w-1/4 text-center border-r border-gray-200" title={inputLabels.f}>{inputLabels.f.split(' ')[0]}</span>
                                  <span className="w-1/4 text-center border-r border-gray-200" title={inputLabels.t}>{inputLabels.t.split(' ')[0]}</span>
                                  <span className="w-1/4 text-center font-bold text-blue-700 border-r border-gray-200">%Real</span>
                                  <span className="w-1/4 text-center font-bold text-gray-700">%Acum</span>
                                </div>
                              </>
                            } colKey={m} className="min-w-[160px] bg-inherit" />
                          ))}
                          <th className="w-10 bg-inherit border-b border-gray-300"></th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {filteredIndicators.map((ind, idx) => (
                          <tr key={ind.id} className={`hover:bg-blue-50 transition-colors ${ind.groupColor ? ind.groupColor : 'bg-white'}`}>
                            <td className={`p-0 border-r border-gray-200 sticky left-0 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] ${ind.groupColor ? ind.groupColor : 'bg-white'}`} title={ind.name}>
                              <div className="flex items-center w-full h-full pr-1">
                                <input type="text" value={ind.name} onChange={(e) => updateIndicatorMeta(ind.id, 'name', e.target.value)} className="flex-1 min-w-0 h-full px-2 py-1 bg-transparent border-none focus:ring-0 truncate cursor-text font-medium outline-none"/>
                                <button onClick={() => setSelectedIndicator(ind)} className="text-gray-400 hover:text-blue-600 transition-colors p-1.5 rounded-md hover:bg-blue-100 mr-1" title="Ver Gráfico"><i className="fas fa-chart-line"></i></button>
                              </div>
                            </td>
                            {showWeight && <td className="p-0 border-r border-gray-200"><input type="number" value={ind.weight} onChange={(e)=>updateIndicatorMeta(ind.id,'weight',e.target.value)} className="w-full text-center border-none focus:ring-0 bg-transparent"/></td>}
                            {ind.months.map((m, mIdx) => {
                               let realBg = "text-gray-300";
                               if (m.real !== null) realBg = m.real >= ind.target ? "bg-green-100 text-green-700 font-bold" : "bg-red-100 text-red-700 font-bold";
                               
                               const isReadOnly = ind.isMain;

                               return (
                                  <td key={mIdx} className="p-0 border-r border-gray-200 min-w-[160px]">
                                    <div className={`flex items-stretch ${rowDensity === 'compact' ? 'h-6' : rowDensity === 'spacious' ? 'h-10' : 'h-8'}`}>
                                       <input 
                                         type="number" 
                                         value={m.falseVal ?? ''} 
                                         readOnly={isReadOnly}
                                         onChange={(e)=>!isReadOnly && updateValues(ind.id, mIdx, 'falseVal', e.target.value)} 
                                         className={`w-1/4 text-center text-[10px] border-r border-gray-100 focus:outline-none p-0 m-0 ${isReadOnly ? 'bg-transparent text-gray-500' : 'bg-white hover:bg-gray-50'}`}
                                       />
                                       <input 
                                         type="number" 
                                         value={m.trueVal ?? ''} 
                                         readOnly={isReadOnly}
                                         onChange={(e)=>!isReadOnly && updateValues(ind.id, mIdx, 'trueVal', e.target.value)} 
                                         className={`w-1/4 text-center text-[10px] border-r border-gray-100 focus:outline-none p-0 m-0 ${isReadOnly ? 'bg-transparent text-gray-500' : 'bg-white hover:bg-gray-50'}`}
                                       />
                                       <div className={`w-1/4 flex items-center justify-center text-[9px] border-r border-white ${realBg}`}>{m.real ?? '-'}</div>
                                       <div className={`w-1/4 flex items-center justify-center text-[9px] font-bold bg-transparent`}>{m.acum ?? '-'}</div>
                                    </div>
                                  </td>
                               );
                            })}
                              <td className="p-0 text-center">
                              <button onClick={() => deleteIndicator(ind.id)} className="text-gray-300 hover:text-red-500 p-1"><i className="fas fa-trash text-xs"></i></button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const DirectorateContainer = ({ user }) => {
          const [activeSubTab, setActiveSubTab] = useState('result_nivel');

          return (
            <div className="flex flex-col h-full gap-4">
              <div className="flex gap-2 bg-white/50 p-1 rounded-lg w-fit backdrop-blur-sm overflow-x-auto">
                <button onClick={() => setActiveSubTab('result_nivel')} className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-bold transition-all whitespace-nowrap ${activeSubTab === 'result_nivel' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-white/50'}`}>
                  <i className="fas fa-wave-square"></i> Result. Nível Serviço
                </button>
                <button onClick={() => setActiveSubTab('sla')} className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-bold transition-all whitespace-nowrap ${activeSubTab === 'sla' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-white/50'}`}>
                  <i className="fas fa-bullseye"></i> Painel SLA
                </button>
                <button onClick={() => setActiveSubTab('backlog')} className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-bold transition-all whitespace-nowrap ${activeSubTab === 'backlog' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-white/50'}`}>
                  <i className="fas fa-layer-group"></i> Backlog
                </button>
                <button onClick={() => setActiveSubTab('rt_gov')} className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-bold transition-all whitespace-nowrap ${activeSubTab === 'rt_gov' ? 'bg-purple-600 text-white shadow-md' : 'text-gray-600 hover:bg-white/50'}`}>
                  <i className="fas fa-clipboard-list"></i> RT Governança 2026
                </button>
              </div>

              <div className="flex-1 overflow-hidden">
                {activeSubTab === 'result_nivel' && (
                  <DynamicTable 
                    user={user} 
                    collectionName="dir_result_nivel_servico_v3_fixed" 
                    title="Result. Nível Serviço" 
                    subtitle="Visão Executiva de Indicadores" 
                    generator={generateServiceLevelData}
                    showWeight={true}
                  />
                )}
                {activeSubTab === 'sla' && (
                  <DynamicTable 
                    user={user} 
                    collectionName="dir_sla_specific_v2_clean" 
                    title="Painel SLA" 
                    subtitle="Acordo de Nível de Serviço (SLA) - Específico" 
                    generator={generateSlaData}
                    showWeight={false}
                  />
                )}
                {activeSubTab === 'backlog' && (
                  <DynamicTable 
                    user={user} 
                    collectionName="dir_backlog_v1_fixed" 
                    title="Backlog" 
                    subtitle="Volume de Chamados Pendentes" 
                    generator={generateBacklogData}
                    showWeight={false}
                    inputLabels={{ f: "Fora Pz", t: "Total" }}
                    calculationType="backlog"
                  />
                )}
                {activeSubTab === 'rt_gov' && (
                  <DirectorateSummaryTable user={user} />
                )}
              </div>
            </div>
          );
        };

        // ==========================================
        // 5.5. NOVOS MÓDULOS DE GOVERNANÇA BI
        // ==========================================
        
        // Conversor inteligente de TMA para horas plotáveis
        const parseTmaToHours = (tmaStr) => {
            if (!tmaStr) return 0;
            const s = tmaStr.toLowerCase();
            let hours = 0;
            const dMatch = s.match(/(\d+)\s*dia/);
            if (dMatch) hours += parseInt(dMatch[1], 10) * 24;
            const hMatch = s.match(/(\d+)\s*hora/);
            if (hMatch) hours += parseInt(hMatch[1], 10);
            const mMatch = s.match(/(\d+)\s*minuto/);
            if (mMatch) hours += parseInt(mMatch[1], 10) / 60;
            return hours;
        };

        const GovBiChartModal = ({ title, data, target, chartType, lowerIsBetter, onClose, isTma = false }) => {
          const svgRef = useRef(null);
          
          const validData = data.map(d => d === null || isNaN(d) ? 0 : d);
          const rawMax = Math.max(target, ...validData);
          const maxY = isTma ? rawMax * 1.5 : (rawMax * 1.2 || 100);

          const width = 600; const height = 300; const padding = 50; 
          const graphWidth = width - padding * 2; const graphHeight = height - padding * 2; 
          
          const getX = (index) => padding + (index * (graphWidth / (validData.length - 1 || 1)));
          const getY = (val) => height - padding - ((val / maxY) * graphHeight);
          
          const exportChart = () => {
            if (!svgRef.current) return;
            const svg = svgRef.current;
            const svgData = new XMLSerializer().serializeToString(svg);
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const img = new Image();
            
            img.onload = () => {
              canvas.width = width;
              canvas.height = height;
              ctx.fillStyle = "white"; 
              ctx.fillRect(0, 0, width, height);
              ctx.drawImage(img, 0, 0);
              const a = document.createElement("a");
              a.download = `Grafico_${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;
              a.href = canvas.toDataURL("image/png");
              a.click();
            };
            img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgData)));
          };

          const formatY = (val) => isTma ? `${Math.round(val)}h` : Math.round(val);

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
              <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-3xl relative">
                <div className="flex justify-between items-start mb-6 pr-6">
                  <div>
                     <h3 className="text-xl font-bold text-gray-800 mb-2 truncate">{title}</h3>
                     <div className="flex gap-4 text-xs text-gray-500 font-medium">
                       <span className="flex items-center gap-1.5"><div className="w-3 h-3 bg-[#064e3b] rounded-sm"></div> Bom (Dentro da Meta)</span>
                       <span className="flex items-center gap-1.5"><div className="w-3 h-3 bg-[#7f1d1d] rounded-sm"></div> Ruim (Fora da Meta)</span>
                       <span className="bg-gray-100 px-2 py-0.5 rounded text-gray-700">Meta: {target} {isTma ? 'Horas' : ''}</span>
                     </div>
                  </div>
                  <button onClick={exportChart} className="shrink-0 text-sm bg-blue-50 hover:bg-blue-100 text-blue-600 px-4 py-2 rounded-lg flex items-center gap-2 font-bold transition-colors border border-blue-200 shadow-sm">
                      <i className="fas fa-download"></i> Exportar Gráfico
                  </button>
                </div>

                <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition-colors">
                    <i className="fas fa-times w-5 h-5 flex items-center justify-center"></i>
                </button>

                <div className="flex justify-center bg-gray-50/50 rounded-xl p-4 border border-gray-100">
                  <svg ref={svgRef} xmlns="http://www.w3.org/2000/svg" width={width} height={height} viewBox={`0 0 ${width} ${height}`} className="w-full h-auto overflow-visible bg-white rounded">
                    <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#e5e7eb" strokeWidth="1.5" />
                    <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#e5e7eb" strokeWidth="1.5" />
                    
                    {[0, maxY/2, maxY].map(val => (
                      <g key={val}>
                        <line x1={padding} y1={getY(val)} x2={width - padding} y2={getY(val)} stroke="#f3f4f6" strokeDasharray="4" />
                        <text x={padding - 10} y={getY(val) + 4} textAnchor="end" fontSize="11" fontFamily="sans-serif" fill="#9ca3af" fontWeight="bold">{formatY(val)}</text>
                      </g>
                    ))}

                    <line x1={padding} y1={getY(target)} x2={width - padding} y2={getY(target)} stroke="#ca8a04" strokeWidth="2" strokeDasharray="5" />
                    <text x={padding - 10} y={getY(target) + 15} textAnchor="end" fill="#ca8a04" fontSize="10" fontFamily="sans-serif" fontWeight="bold">Meta</text>

                    {chartType === 'bar' && validData.map((val, i) => {
                      const isGood = lowerIsBetter ? val <= target : val >= target;
                      const color = isGood ? '#064e3b' : '#7f1d1d';
                      const barH = ((val / maxY) * graphHeight);
                      return (
                        <g key={i}>
                          <rect x={getX(i) - 12} y={getY(val)} width={24} height={barH} fill={color} opacity="0.9" rx="3"/>
                          <text x={getX(i)} y={height - padding + 20} textAnchor="middle" fontSize="11" fontFamily="sans-serif" fill="#6b7280" fontWeight="bold">{MONTHS[i]}</text>
                        </g>
                      )
                    })}

                    {chartType === 'line' && (
                      <>
                        <path d={validData.reduce((acc, val, i) => `${acc} ${i === 0 ? 'M' : 'L'} ${getX(i)} ${getY(val)}`, "")} fill="none" stroke="#9ca3af" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" />
                        {validData.map((val, i) => {
                           const isGood = lowerIsBetter ? val <= target : val >= target;
                           const color = isGood ? '#064e3b' : '#7f1d1d';
                           return (
                             <g key={i}>
                               <circle cx={getX(i)} cy={getY(val)} r="5" fill={color} stroke="white" strokeWidth="2" />
                               <text x={getX(i)} y={height - padding + 20} textAnchor="middle" fontSize="11" fontFamily="sans-serif" fill="#6b7280" fontWeight="bold">{MONTHS[i]}</text>
                             </g>
                           )
                        })}
                      </>
                    )}
                  </svg>
                </div>
              </div>
            </div>
          );
        };


        const SlaGovernancaTab = ({ user }) => {
          const [data, setData] = useState(Array.from({length: 12}, () => ({ noPrazo: null, expirados: null })));
          const [meta, setMeta] = useState(96.41);
          const [showChart, setShowChart] = useState(false);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
            if (!user) return;
            const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'gov_bi', 'sla'), (d) => {
               if (d.exists()) {
                 if (d.data().months) setData(d.data().months);
                 if (d.data().meta !== undefined) setMeta(d.data().meta);
               }
               setLoading(false);
            }, (error) => {
               console.error("Erro no ouvinte do SLA Gov:", error);
               setLoading(false);
            });
            return unsub;
          }, [user]);

          const handleUpdate = async (idx, field, val) => {
             const newM = [...data];
             newM[idx] = { ...newM[idx], [field]: val === '' ? null : Number(val) };
             setData(newM);
             if (user) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gov_bi', 'sla'), { months: newM }, { merge: true });
          };

          const handleMetaUpdate = async (val) => {
             const num = parseFloat(val);
             setMeta(num);
             if (user && !isNaN(num)) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gov_bi', 'sla'), { meta: num }, { merge: true });
          };

          let sumNoPrazo = 0; let sumExpirados = 0;
          const computed = (data || []).map(m => {
             const np = m?.noPrazo || 0; const exp = m?.expirados || 0;
             const tot = np + exp;
             const pReal = tot > 0 ? ((np / tot)*100).toFixed(2) : '-';
             sumNoPrazo += np; sumExpirados += exp;
             const totAcum = sumNoPrazo + sumExpirados;
             const pAcum = totAcum > 0 ? ((sumNoPrazo / totAcum)*100).toFixed(2) : '-';
             return { ...m, tot, pReal, totAcum, pAcum, sumNoPrazo, sumExpirados };
          });

          const chartData = computed.map(c => parseFloat(c.pReal) || 0);

          if (loading) return <div className="flex flex-col items-center justify-center h-full gap-4 text-white"><i className="fas fa-spinner fa-spin text-4xl"></i><p>Carregando SLA Governança...</p></div>;

          return (
             <div className="bg-white/95 backdrop-blur-md rounded-lg shadow-xl border border-white/50 flex flex-col h-full animate-in slide-in-from-bottom-4 duration-500 overflow-hidden relative">
               {showChart && <GovBiChartModal title="SLA Governança (% Real)" data={chartData} target={meta} chartType="bar" lowerIsBetter={false} onClose={() => setShowChart(false)} />}
               
               <div className="p-4 border-b border-gray-200 bg-white/50 flex flex-col sm:flex-row justify-between items-center gap-4 z-20">
                 <div className="flex items-center">
                   <div>
                     <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><i className="fas fa-clock text-blue-600"></i> SLA Governança</h2>
                     <p className="text-xs text-gray-500 mt-1">Acompanhamento de Atendimentos Fechados vs Expirados</p>
                   </div>
                   <button onClick={() => setShowChart(true)} className="ml-4 text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg shadow-sm text-xs font-bold flex items-center gap-2 transition-colors"><i className="fas fa-chart-bar"></i> Gráfico</button>
                 </div>
               </div>
               <div className="flex-1 overflow-auto bg-gray-100 p-4">
                 <div className="bg-white rounded-lg shadow border border-gray-300 overflow-hidden h-full">
                   <div className="overflow-auto h-full">
                     <table className="min-w-max text-sm border-collapse w-full">
                       <thead className="bg-gray-200 text-gray-700 sticky top-0 shadow-md">
                          <tr>
                            <th className="p-3 text-left font-bold border-b border-gray-300">MÊS</th>
                            <th className="p-3 text-center border-b border-gray-300" title="Atendimentos fechados não expirados">No Prazo (F)</th>
                            <th className="p-3 text-center border-b border-gray-300" title="Atendimentos fechados expirados">Expirados (T)</th>
                            <th className="p-3 text-center border-b border-gray-300 bg-blue-100/50">Total Real</th>
                            <th className="p-3 text-center border-b border-gray-300 bg-blue-100/50">% Real</th>
                            <th className="p-3 text-center border-b border-gray-300">No Prazo Acum</th>
                            <th className="p-3 text-center border-b border-gray-300">Expirados Acum</th>
                            <th className="p-3 text-center border-b border-gray-300 bg-green-100/50">Total Acum</th>
                            <th className="p-3 text-center border-b border-gray-300 bg-green-100/50">% Acum</th>
                            <th className="p-2 text-center border-b border-gray-300 bg-gray-100">
                               <div className="flex flex-col items-center">
                                  <span className="text-[10px] uppercase text-gray-500 mb-1">Meta Global (%)</span>
                                  <input type="number" step="0.01" className="w-16 text-center font-bold outline-none border border-gray-300 rounded focus:border-blue-500 px-1 py-0.5" value={meta} onChange={e => handleMetaUpdate(e.target.value)} />
                               </div>
                            </th>
                          </tr>
                       </thead>
                       <tbody className="divide-y divide-gray-200 bg-white">
                          {MONTHS.map((m, i) => {
                              const row = computed[i] || {};
                              const pRealVal = parseFloat(row.pReal);
                              const realColor = pRealVal >= meta ? 'text-green-600' : pRealVal < meta ? 'text-red-600' : 'text-gray-700';
                              const pAcumVal = parseFloat(row.pAcum);
                              const acumColor = pAcumVal >= meta ? 'text-green-600' : pAcumVal < meta ? 'text-red-600' : 'text-gray-700';

                              return (
                                <tr key={i} className="hover:bg-blue-50 transition-colors">
                                  <td className="p-3 font-medium border-r border-gray-100 bg-gray-50">{GOV_MONTHS_ROWS[i]}</td>
                                  <td className="p-0 border-r border-gray-100"><input type="number" className="w-full h-10 text-center outline-none focus:bg-blue-50 bg-transparent text-gray-700" value={row.noPrazo ?? ''} onChange={e => handleUpdate(i, 'noPrazo', e.target.value)} /></td>
                                  <td className="p-0 border-r border-gray-100"><input type="number" className="w-full h-10 text-center outline-none focus:bg-blue-50 bg-transparent text-gray-700" value={row.expirados ?? ''} onChange={e => handleUpdate(i, 'expirados', e.target.value)} /></td>
                                  <td className="p-3 text-center font-bold bg-blue-50/30 text-gray-700">{row.tot || '-'}</td>
                                  <td className={`p-3 text-center font-bold bg-blue-50/30 ${realColor}`}>{row.pReal !== '-' ? row.pReal + '%' : '-'}</td>
                                  <td className="p-3 text-center text-gray-500">{row.sumNoPrazo || '-'}</td>
                                  <td className="p-3 text-center text-gray-500">{row.sumExpirados || '-'}</td>
                                  <td className="p-3 text-center font-bold bg-green-50/30 text-gray-700">{row.totAcum || '-'}</td>
                                  <td className={`p-3 text-center font-bold bg-green-50/30 ${acumColor}`}>{row.pAcum !== '-' ? row.pAcum + '%' : '-'}</td>
                                  <td className="p-3 text-center font-bold text-gray-400 bg-gray-50">{meta}%</td>
                                </tr>
                              )
                          })}
                       </tbody>
                     </table>
                   </div>
                 </div>
               </div>
             </div>
          );
        };

        const AcuracidadeTab = ({ user }) => {
          const [data, setData] = useState(Array.from({length: 12}, () => ({ revisados: null, visualizados: null })));
          const [meta, setMeta] = useState(90);
          const [showChart, setShowChart] = useState(false);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
            if (!user) return;
            const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'gov_bi', 'acuracidade'), (d) => {
               if (d.exists()) {
                 if (d.data().months) setData(d.data().months);
                 if (d.data().meta !== undefined) setMeta(d.data().meta);
               }
               setLoading(false);
            }, (error) => {
               console.error("Erro no ouvinte de Acuracidade:", error);
               setLoading(false);
            });
            return unsub;
          }, [user]);

          const handleUpdate = async (idx, field, val) => {
             const newM = [...data];
             newM[idx] = { ...newM[idx], [field]: val === '' ? null : Number(val) };
             setData(newM);
             if (user) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gov_bi', 'acuracidade'), { months: newM }, { merge: true });
          };

          const handleMetaUpdate = async (val) => {
             const num = parseFloat(val);
             setMeta(num);
             if (user && !isNaN(num)) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gov_bi', 'acuracidade'), { meta: num }, { merge: true });
          };

          const computed = (data || []).map(m => {
              const rev = m?.revisados ?? null; const vis = m?.visualizados ?? null;
              let p = '-'; let rCalc = '-'; let vCalc = '-';
              if (rev !== null && vis !== null) {
                  const rScore = Math.min(100, Math.max(0, rev + 75));
                  const vScore = Math.min(100, Math.max(0, vis - 50));
                  rCalc = rScore; vCalc = vScore;
                  p = ((rScore * 0.5) + (vScore * 0.5)).toFixed(2);
              }
              return { ...m, p, rCalc, vCalc };
          });

          const chartData = computed.map(c => parseFloat(c.p) || 0);

          if (loading) return <div className="flex flex-col items-center justify-center h-full gap-4 text-white"><i className="fas fa-spinner fa-spin text-4xl"></i><p>Carregando Acuracidade da Base...</p></div>;

          return (
             <div className="bg-white/95 backdrop-blur-md rounded-lg shadow-xl border border-white/50 flex flex-col h-full animate-in slide-in-from-bottom-4 duration-500 overflow-hidden relative">
               {showChart && <GovBiChartModal title="Acuracidade da Base (%)" data={chartData} target={meta} chartType="bar" lowerIsBetter={false} onClose={() => setShowChart(false)} />}
               
               <div className="p-4 border-b border-gray-200 bg-white/50 flex flex-col sm:flex-row justify-between items-center gap-4 z-20">
                 <div className="flex items-center">
                   <div>
                     <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><i className="fas fa-check-circle text-purple-600"></i> Acuracidade da Base</h2>
                     <p className="text-xs text-gray-500 mt-1">Cálculo de Base de Conhecimento e Revisões</p>
                   </div>
                   <button onClick={() => setShowChart(true)} className="ml-4 text-purple-500 hover:text-purple-700 bg-purple-50 hover:bg-purple-100 p-2 rounded-lg shadow-sm text-xs font-bold flex items-center gap-2 transition-colors"><i className="fas fa-chart-bar"></i> Gráfico</button>
                 </div>
               </div>
               <div className="flex-1 overflow-auto bg-gray-100 p-4">
                 <div className="bg-white rounded-lg shadow border border-gray-300 overflow-hidden h-full">
                   <div className="overflow-auto h-full">
                     <table className="min-w-max text-sm border-collapse w-full">
                       <thead className="bg-gray-200 text-gray-700 sticky top-0 shadow-md">
                          <tr>
                            <th className="p-3 text-left font-bold border-b border-gray-300">Mês</th>
                            <th className="p-3 text-center border-b border-gray-300">Peso</th>
                            <th className="p-3 text-center border-b border-gray-300 bg-purple-50">Criados/Expirados Revisados</th>
                            <th className="p-3 text-center border-b border-gray-300 bg-purple-50">Conhecimentos Visualizados</th>
                            <th className="p-3 text-center border-b border-gray-300 bg-indigo-50" title="Valor calculado (+75) limitado a 100">Rev (Cálculo)</th>
                            <th className="p-3 text-center border-b border-gray-300 bg-indigo-50" title="Valor calculado (-50) limitado a 100">Vis (Cálculo)</th>
                            <th className="p-3 text-center border-b border-gray-300 bg-indigo-100 text-indigo-900">% Real/Acumulado</th>
                            <th className="p-2 text-center border-b border-gray-300 bg-gray-100">
                               <div className="flex flex-col items-center">
                                  <span className="text-[10px] uppercase text-gray-500 mb-1">Meta (%)</span>
                                  <input type="number" step="0.1" className="w-16 text-center font-bold outline-none border border-gray-300 rounded focus:border-purple-500 px-1 py-0.5" value={meta} onChange={e => handleMetaUpdate(e.target.value)} />
                               </div>
                            </th>
                          </tr>
                       </thead>
                       <tbody className="divide-y divide-gray-200 bg-white">
                          {MONTHS.map((m, i) => {
                              const row = computed[i] || {};
                              const pVal = parseFloat(row.p);
                              const color = pVal >= meta ? 'text-green-600' : pVal < meta ? 'text-red-600' : 'text-indigo-700';

                              return (
                                <tr key={i} className="hover:bg-purple-50 transition-colors">
                                  <td className="p-3 font-medium border-r border-gray-100 bg-gray-50">{GOV_MONTHS_ROWS[i]}</td>
                                  <td className="p-3 text-center text-gray-500 font-bold border-r border-gray-100">0.5</td>
                                  <td className="p-0 border-r border-gray-100"><input type="number" className="w-full h-10 text-center outline-none focus:bg-purple-50 bg-transparent text-gray-700 font-medium" value={row.revisados ?? ''} onChange={e => handleUpdate(i, 'revisados', e.target.value)} /></td>
                                  <td className="p-0 border-r border-gray-100"><input type="number" className="w-full h-10 text-center outline-none focus:bg-purple-50 bg-transparent text-gray-700 font-medium" value={row.visualizados ?? ''} onChange={e => handleUpdate(i, 'visualizados', e.target.value)} /></td>
                                  <td className="p-3 text-center text-gray-600 bg-indigo-50/30">{row.rCalc || '-'}</td>
                                  <td className="p-3 text-center text-gray-600 bg-indigo-50/30">{row.vCalc || '-'}</td>
                                  <td className={`p-3 text-center font-bold bg-indigo-100/30 text-lg ${color}`}>{row.p && row.p !== '-' ? row.p + '%' : '-'}</td>
                                  <td className="p-3 text-center font-bold text-gray-400 bg-gray-50">{meta}%</td>
                                </tr>
                              )
                          })}
                       </tbody>
                     </table>
                   </div>
                 </div>
               </div>
             </div>
          );
        };

        const IrosTab = ({ user }) => {
          const [data, setData] = useState(Array.from({length: 12}, () => ({ req: null, inc: null, antigos: null, vazio: null, semResolv: null, encerrados: null })));
          const [meta, setMeta] = useState(0.04);
          const [showChart, setShowChart] = useState(false);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
            if (!user) return;
            const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'gov_bi', 'iros'), (d) => {
               if (d.exists()) {
                 if (d.data().months) setData(d.data().months);
                 if (d.data().meta !== undefined) setMeta(d.data().meta);
               }
               setLoading(false);
            }, (error) => {
               console.error("Erro no ouvinte do IROS:", error);
               setLoading(false);
            });
            return unsub;
          }, [user]);

          const handleUpdate = async (idx, field, val) => {
            const newM = [...data];
            newM[idx] = { ...newM[idx], [field]: val === '' ? null : Number(val) };
            setData(newM);
            if (user) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gov_bi', 'iros'), { months: newM }, { merge: true });
          };

          const handleMetaUpdate = async (val) => {
             const num = parseFloat(val);
             setMeta(num);
             if (user && !isNaN(num)) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gov_bi', 'iros'), { meta: num }, { merge: true });
          };

          const rows = [
              { k: 'req', label: 'Backlog Requisição (Últimos 3 meses)' },
              { k: 'inc', label: 'Backlog Incidente (Últimos 3 meses)' },
              { k: 'tot_backlog', label: 'Total Backlog (Últimos 3 meses)', readonly: true },
              { k: 'spacer', label: '', empty: true },
              { k: 'antigos', label: 'Total Backlogs antigos' },
              { k: 'vazio', label: 'Total Tarefas com Grupo vazio' },
              { k: 'semResolv', label: 'Total Grupos sem Resolvedores' },
              { k: 'encerrados', label: 'Total Processos Encerrados' },
              { k: 'iros', label: 'IROS (Índice de Resolutividade Otimizada)', readonly: true }
          ];

          // Array para o gráfico pegando apenas o IROS consolidado
          const chartData = MONTHS.map((_, i) => {
             const d = data[i] || {};
             const num = (d.antigos||0) + (d.vazio||0) + (d.semResolv||0);
             if (d.encerrados > 0) return parseFloat((num / d.encerrados).toFixed(6));
             return 0;
          });

          if (loading) return <div className="flex flex-col items-center justify-center h-full gap-4 text-white"><i className="fas fa-spinner fa-spin text-4xl"></i><p>Carregando IROS...</p></div>;

          return (
             <div className="bg-white/95 backdrop-blur-md rounded-lg shadow-xl border border-white/50 flex flex-col h-full animate-in slide-in-from-bottom-4 duration-500 overflow-hidden relative">
               {showChart && <GovBiChartModal title="Índice IROS" data={chartData} target={meta} chartType="bar" lowerIsBetter={true} onClose={() => setShowChart(false)} />}

               <div className="p-4 border-b border-gray-200 bg-white/50 flex flex-col sm:flex-row justify-between items-center gap-4 z-20">
                 <div className="flex items-center">
                   <div>
                     <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><i className="fas fa-chart-area text-yellow-600"></i> IROS</h2>
                     <p className="text-xs text-gray-500 mt-1">Soma de Backlogs, Tarefas e Processos Encerrados</p>
                   </div>
                   <button onClick={() => setShowChart(true)} className="ml-4 text-yellow-600 hover:text-yellow-700 bg-yellow-50 hover:bg-yellow-100 p-2 rounded-lg shadow-sm text-xs font-bold flex items-center gap-2 transition-colors"><i className="fas fa-chart-bar"></i> Gráfico</button>
                 </div>
                 <div className="flex items-center bg-gray-100 p-2 rounded-lg shadow-inner">
                    <span className="text-xs uppercase text-gray-500 font-bold mr-2">Meta IROS:</span>
                    <input type="number" step="0.01" className="w-20 text-center font-bold outline-none border border-gray-300 rounded focus:border-yellow-500 px-1 py-1" value={meta} onChange={e => handleMetaUpdate(e.target.value)} />
                 </div>
               </div>
               <div className="flex-1 overflow-auto bg-gray-100 p-4">
                 <div className="bg-white rounded-lg shadow border border-gray-300 overflow-hidden h-full">
                   <div className="overflow-auto h-full pb-2">
                     <table className="min-w-max text-sm border-collapse w-full">
                       <thead className="bg-gray-200 text-gray-700 sticky top-0 shadow-md z-10">
                          <tr>
                            <th className="p-3 text-left font-bold border-b border-gray-300 w-[350px] sticky left-0 bg-gray-200 z-20 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.2)]">Métrica / Mês</th>
                            {MONTHS.map(m => <th key={m} className="p-3 text-center border-b border-gray-300 min-w-[120px]">{m}</th>)}
                          </tr>
                       </thead>
                       <tbody className="divide-y divide-gray-200 bg-white">
                          {rows.map(r => {
                             if (r.empty) return <tr key="spacer" className="bg-gray-100 h-4 border-y border-gray-300"> <td colSpan="13"></td> </tr>;

                             const isResult = r.k === 'iros';
                             const isSubResult = r.k === 'tot_backlog';
                             
                             return (
                                <tr key={r.k} className={`hover:bg-yellow-50 transition-colors ${r.readonly ? 'bg-gray-50/50' : ''}`}>
                                   <td className={`p-3 border-r border-gray-200 sticky left-0 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] bg-inherit ${isResult ? 'font-bold text-yellow-700 bg-yellow-100/50' : isSubResult ? 'font-bold text-blue-700 bg-blue-50/50' : 'text-gray-700 font-medium'}`}>{r.label}</td>
                                   {MONTHS.map((m, i) => {
                                      const d = data[i] || {};
                                      let val = '';
                                      if (r.k === 'tot_backlog') {
                                         if (d.req != null || d.inc != null) val = (d.req||0) + (d.inc||0);
                                      } else if (r.k === 'iros') {
                                         const num = (d.antigos||0) + (d.vazio||0) + (d.semResolv||0);
                                         const den = d.encerrados;
                                         if (den > 0) val = (num / den).toFixed(6); 
                                      } else {
                                         val = d[r.k] ?? '';
                                      }
                                      return (
                                         <td key={i} className={`p-0 border-r border-gray-100 ${isResult ? 'bg-yellow-100/50' : isSubResult ? 'bg-blue-50/50' : ''}`}>
                                            {r.readonly ? 
                                               <div className={`w-full h-10 flex items-center justify-center font-bold ${isResult ? (val && parseFloat(val) <= meta ? 'text-green-700 text-lg' : 'text-red-700 text-lg') : 'text-blue-700 text-md'}`}>{val || '-'}</div> : 
                                               <input type="number" className="w-full h-10 text-center outline-none focus:bg-yellow-50 bg-transparent text-gray-700" value={val} onChange={e => handleUpdate(i, r.k, e.target.value)} />
                                            }
                                         </td>
                                      )
                                   })}
                                </tr>
                             )
                          })}
                       </tbody>
                     </table>
                   </div>
                 </div>
               </div>
             </div>
          );
        };

        const TmaTab = ({ user }) => {
          const [data, setData] = useState(Array.from({length: 12}, () => ''));
          const [meta, setMeta] = useState(180); // Ex: Meta em horas
          const [showChart, setShowChart] = useState(false);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
            if (!user) return;
            const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'gov_bi', 'tma'), (d) => {
               if (d.exists()) {
                 if (d.data().months) setData(d.data().months);
                 if (d.data().meta !== undefined) setMeta(d.data().meta);
               }
               setLoading(false);
            }, (error) => {
               console.error("Erro no ouvinte do TMA:", error);
               setLoading(false);
            });
            return unsub;
          }, [user]);

          const handleUpdate = async (idx, val) => {
            const newM = [...data];
            newM[idx] = val;
            setData(newM);
            if (user) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gov_bi', 'tma'), { months: newM }, { merge: true });
          };

          const handleMetaUpdate = async (val) => {
             const num = parseFloat(val);
             setMeta(num);
             if (user && !isNaN(num)) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gov_bi', 'tma'), { meta: num }, { merge: true });
          };

          const chartData = data.map(str => parseTmaToHours(str));

          if (loading) return <div className="flex flex-col items-center justify-center h-full gap-4 text-white"><i className="fas fa-spinner fa-spin text-4xl"></i><p>Carregando TMA...</p></div>;

          return (
             <div className="bg-white/95 backdrop-blur-md rounded-lg shadow-xl border border-white/50 flex flex-col h-full animate-in slide-in-from-bottom-4 duration-500 overflow-hidden relative">
               {showChart && <GovBiChartModal title="TMA Registrado (Em Horas)" data={chartData} target={meta} chartType="line" lowerIsBetter={true} isTma={true} onClose={() => setShowChart(false)} />}
               
               <div className="p-4 border-b border-gray-200 bg-white/50 flex flex-col sm:flex-row justify-between items-center gap-4 z-20">
                 <div className="flex items-center">
                   <div>
                     <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><i className="fas fa-stopwatch text-red-600"></i> TMA</h2>
                     <p className="text-xs text-gray-500 mt-1">Tempo Médio de Atendimento Mensal</p>
                   </div>
                   <button onClick={() => setShowChart(true)} className="ml-4 text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 p-2 rounded-lg shadow-sm text-xs font-bold flex items-center gap-2 transition-colors"><i className="fas fa-chart-line"></i> Gráfico</button>
                 </div>
                 <div className="flex items-center bg-gray-100 p-2 rounded-lg shadow-inner">
                    <span className="text-xs uppercase text-gray-500 font-bold mr-2">Meta (Horas):</span>
                    <input type="number" className="w-20 text-center font-bold outline-none border border-gray-300 rounded focus:border-red-500 px-1 py-1" value={meta} onChange={e => handleMetaUpdate(e.target.value)} title="Meta global convertida em horas" />
                 </div>
               </div>
               <div className="flex-1 overflow-auto bg-gray-100 p-4 flex justify-center">
                 <div className="bg-white rounded-lg shadow border border-gray-300 overflow-hidden w-full max-w-4xl h-fit">
                     <table className="min-w-full text-sm border-collapse">
                       <thead className="bg-gray-200 text-gray-700 shadow-sm">
                          <tr>
                            <th className="p-4 text-left font-bold border-b border-gray-300 w-64">Mês</th>
                            <th className="p-4 text-left font-bold border-b border-gray-300">TMA Registrado</th>
                            <th className="p-4 text-center font-bold border-b border-gray-300 w-48 text-gray-500 text-xs">Conversão (Gráfico)</th>
                          </tr>
                       </thead>
                       <tbody className="divide-y divide-gray-200 bg-white">
                          {MONTHS.map((m, i) => {
                             const parsedHours = parseTmaToHours(data[i]);
                             const isGood = parsedHours <= meta;
                             const color = parsedHours === 0 ? 'text-gray-400' : isGood ? 'text-green-600 font-bold' : 'text-red-600 font-bold';

                             return (
                               <tr key={i} className="hover:bg-red-50 transition-colors">
                                  <td className="p-4 font-bold border-r border-gray-100 bg-gray-50 text-gray-700 uppercase">{GOV_MONTHS_ROWS[i]}</td>
                                  <td className="p-0 border-r border-gray-100">
                                     <input type="text" className="w-full h-14 px-6 outline-none focus:bg-red-50 text-gray-700 font-medium bg-transparent" placeholder="Ex: 7 Dias 15 Horas 28 Minutos 6 Segundos" value={data[i] || ''} onChange={e => handleUpdate(i, e.target.value)} />
                                  </td>
                                  <td className={`p-0 text-center bg-gray-50/50 ${color}`}>
                                     {parsedHours > 0 ? `~${Math.round(parsedHours)}h` : '-'}
                                  </td>
                               </tr>
                             )
                          })}
                       </tbody>
                     </table>
                 </div>
               </div>
             </div>
          );
        };

        const GovBiContainer = ({ user }) => {
          const [activeSubTab, setActiveSubTab] = useState('sla');

          return (
            <div className="flex flex-col h-full gap-4">
              <div className="flex gap-2 bg-white/50 p-1 rounded-lg w-fit backdrop-blur-sm overflow-x-auto shadow-sm border border-white/50">
                <button onClick={() => setActiveSubTab('sla')} className={`flex items-center gap-2 px-5 py-2.5 rounded-md text-sm font-bold transition-all whitespace-nowrap ${activeSubTab === 'sla' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-white/80 hover:text-blue-600'}`}>
                  <i className="fas fa-clock"></i> SLA Governança
                </button>
                <button onClick={() => setActiveSubTab('acuracidade')} className={`flex items-center gap-2 px-5 py-2.5 rounded-md text-sm font-bold transition-all whitespace-nowrap ${activeSubTab === 'acuracidade' ? 'bg-purple-600 text-white shadow-md' : 'text-gray-600 hover:bg-white/80 hover:text-purple-600'}`}>
                  <i className="fas fa-check-circle"></i> Acuracidade da Base
                </button>
                <button onClick={() => setActiveSubTab('iros')} className={`flex items-center gap-2 px-5 py-2.5 rounded-md text-sm font-bold transition-all whitespace-nowrap ${activeSubTab === 'iros' ? 'bg-yellow-600 text-white shadow-md' : 'text-gray-600 hover:bg-white/80 hover:text-yellow-600'}`}>
                  <i className="fas fa-chart-area"></i> IROS
                </button>
                <button onClick={() => setActiveSubTab('tma')} className={`flex items-center gap-2 px-5 py-2.5 rounded-md text-sm font-bold transition-all whitespace-nowrap ${activeSubTab === 'tma' ? 'bg-red-600 text-white shadow-md' : 'text-gray-600 hover:bg-white/80 hover:text-red-600'}`}>
                  <i className="fas fa-stopwatch"></i> TMA
                </button>
              </div>

              <div className="flex-1 overflow-hidden">
                {activeSubTab === 'sla' && <SlaGovernancaTab user={user} />}
                {activeSubTab === 'acuracidade' && <AcuracidadeTab user={user} />}
                {activeSubTab === 'iros' && <IrosTab user={user} />}
                {activeSubTab === 'tma' && <TmaTab user={user} />}
              </div>
            </div>
          );
        };

        const KanbanModule = ({ user }) => {
          const [tasks, setTasks] = useState([]);
          const [loading, setLoading] = useState(true);
          const [newTaskCol, setNewTaskCol] = useState(null);
          const [newTaskText, setNewTaskText] = useState("");
          const columns = ["A Iniciar", "Em execução", "Impedimento", "Finalizado"];

          useEffect(() => {
            if (!user) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'kanban_board_tasks'), orderBy('createdAt', 'asc'));
            const unsubscribe = onSnapshot(q, (snapshot) => {
              setTasks(snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })));
              setLoading(false);
            });
            return () => unsubscribe();
          }, [user]);

          const onDragStart = (e, taskId) => {
            e.dataTransfer.setData('taskId', taskId);
          };

          const onDrop = async (e, newStatus) => {
            e.preventDefault();
            const taskId = e.dataTransfer.getData('taskId');
            if (!taskId || !user) return;
            try {
               await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'kanban_board_tasks', taskId), { status: newStatus });
            } catch (err) {
               console.error("Erro ao mover tarefa", err);
            }
          };

          const saveNewTask = async (status) => {
            if (!newTaskText.trim() || !user) return;
            try {
              await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'kanban_board_tasks'), {
                text: newTaskText.trim(),
                status: status,
                createdAt: Date.now()
              });
              setNewTaskText("");
              setNewTaskCol(null);
            } catch (err) {
              console.error("Erro ao salvar tarefa", err);
            }
          };

          const deleteTask = async (taskId) => {
            if (!user || !confirm("Deseja apagar este cartão?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'kanban_board_tasks', taskId));
          };

          if (loading) return <div className="flex flex-col items-center justify-center h-full gap-4 text-white"><i className="fas fa-spinner fa-spin text-4xl"></i><p>Carregando Kanban...</p></div>;

          return (
            <div className="bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-white/40 flex flex-col h-full animate-in fade-in zoom-in duration-300">
               <div className="p-4 border-b border-gray-200 bg-white/50 flex justify-between items-center z-20">
                 <div>
                    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><i className="fas fa-tasks text-indigo-600"></i> Quadro Kanban</h2>
                    <p className="text-xs text-gray-500 mt-1">Gerenciamento visual de tarefas gerais</p>
                 </div>
               </div>
               <div className="flex-1 overflow-x-auto overflow-y-hidden p-6">
                  <div className="flex gap-6 h-full items-start">
                     {columns.map(col => {
                        let topColor = "bg-gray-300";
                        if(col === "A Iniciar") topColor = "bg-gray-400";
                        if(col === "Em execução") topColor = "bg-blue-500";
                        if(col === "Impedimento") topColor = "bg-red-500";
                        if(col === "Finalizado") topColor = "bg-green-500";

                        return (
                           <div key={col} className="flex-shrink-0 w-80 bg-gray-100/90 rounded-lg shadow-sm flex flex-col max-h-full border border-gray-200" onDragOver={(e) => e.preventDefault()} onDrop={(e) => onDrop(e, col)}>
                              <div className={`h-1.5 w-full rounded-t-lg ${topColor}`}></div>
                              <div className="px-4 py-3 font-bold text-gray-700 flex justify-between items-center">
                                 {col}
                                 <span className="bg-white shadow-sm text-gray-600 text-xs px-2 py-0.5 rounded-full border border-gray-200">{tasks.filter(t => t.status === col).length}</span>
                              </div>
                              <div className="flex-1 p-3 overflow-y-auto space-y-3">
                                 {tasks.filter(t => t.status === col).map(task => (
                                    <div key={task.id} draggable onDragStart={(e) => onDragStart(e, task.id)} className="p-3 bg-white rounded-md shadow-sm border border-gray-200 cursor-grab active:cursor-grabbing hover:ring-2 hover:ring-indigo-400 relative group transition-all">
                                       <p className="text-sm text-gray-800 pr-6 break-words whitespace-pre-wrap">{task.text}</p>
                                       <button onClick={() => deleteTask(task.id)} className="absolute top-2 right-2 text-gray-400 hover:text-red-500 hidden group-hover:block transition-colors" title="Excluir cartão"><i className="fas fa-trash-alt text-xs"></i></button>
                                    </div>
                                 ))}
                                 {newTaskCol === col && (
                                    <div className="p-3 bg-white rounded-md shadow-sm border border-indigo-300 animate-in fade-in">
                                       <textarea autoFocus value={newTaskText} onChange={e => setNewTaskText(e.target.value)} className="w-full p-1 border-none outline-none resize-none text-sm text-gray-800 bg-transparent" placeholder="Descreva a tarefa..." rows="2" />
                                       <div className="flex gap-2 mt-2">
                                          <button onClick={() => saveNewTask(col)} className="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded text-xs font-bold transition-colors">Salvar</button>
                                          <button onClick={() => {setNewTaskCol(null); setNewTaskText("");}} className="text-gray-500 hover:text-gray-700 px-2 py-1.5 rounded text-xs font-medium transition-colors">Cancelar</button>
                                       </div>
                                    </div>
                                 )}
                              </div>
                              {!newTaskCol || newTaskCol !== col ? (
                                 <div className="p-2 border-t border-gray-200/50">
                                    <button onClick={() => { setNewTaskCol(col); setNewTaskText(''); }} className="w-full text-left text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 px-3 py-2 rounded-md transition-colors text-sm font-medium flex items-center gap-2"><i className="fas fa-plus"></i> Adicionar cartão</button>
                                 </div>
                              ) : null}
                           </div>
                        );
                     })}
                  </div>
               </div>
            </div>
          );
        };

        // ==========================================
        // 6. LAYOUT PRINCIPAL (APP)
        // ==========================================
        function PortalCSC() {
          const [user, setUser] = useState(null);
          const [activeTab, setActiveTab] = useState('projects'); 
          const [isSidebarOpen, setIsSidebarOpen] = useState(true);

          useEffect(() => {
            const initAuth = async () => {
              try {
                await signInAnonymously(auth);
              } catch(e) {
                console.error("Auth error:", e);
              }
            };
            initAuth();
            return onAuthStateChanged(auth, setUser);
          }, []);

          return (
            <div className="flex h-screen bg-gray-900 font-sans overflow-hidden">
              <div className="fixed inset-0 z-0">
                <div className="absolute inset-0 bg-gradient-to-br from-blue-900 via-purple-900 to-black opacity-80 z-0" />
                <img src={BACKGROUND_IMAGE} alt="Background" className="w-full h-full object-cover opacity-40 mix-blend-overlay" onError={(e) => e.target.style.display = 'none'} />
              </div>

              <div className={`relative z-20 bg-white/95 backdrop-blur shadow-2xl transition-all duration-300 flex flex-col ${isSidebarOpen ? 'w-72' : 'w-20'}`}>
                <div className="h-24 flex items-center justify-center border-b border-gray-100 relative">
                  {isSidebarOpen ? (
                    <div className="flex flex-col items-center">
                       <h1 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">PORTAL CSC</h1>
                       <span className="text-[10px] uppercase tracking-widest text-gray-400">Desempenho & Governança</span>
                    </div>
                  ) : (
                    <span className="font-bold text-blue-600 text-2xl">CSC</span>
                  )}
                  <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="absolute -right-3 top-10 bg-blue-600 text-white border border-white rounded-full p-1.5 shadow-lg hover:scale-110 transition-transform">
                    {isSidebarOpen ? <i className="fas fa-chevron-left w-3 h-3 text-[10px] flex items-center justify-center"></i> : <i className="fas fa-bars w-3 h-3 text-[10px] flex items-center justify-center"></i>}
                  </button>
                </div>

                <nav className="flex-1 py-6 px-3 space-y-3 overflow-y-auto">
                  <button onClick={() => setActiveTab('projects')} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl transition-all duration-200 group ${activeTab === 'projects' ? 'bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-lg' : 'text-gray-500 hover:bg-gray-50 hover:text-blue-600'}`}>
                    <i className={`fas fa-columns text-xl shrink-0 ${activeTab === 'projects' ? 'text-white' : 'text-gray-400 group-hover:text-blue-600'}`}></i>
                    {isSidebarOpen && <span className="font-medium">Painel de Projetos</span>}
                  </button>

                  <button onClick={() => setActiveTab('kanban')} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl transition-all duration-200 group ${activeTab === 'kanban' ? 'bg-gradient-to-r from-indigo-600 to-indigo-500 text-white shadow-lg' : 'text-gray-500 hover:bg-gray-50 hover:text-indigo-600'}`}>
                    <i className={`fas fa-tasks text-xl shrink-0 ${activeTab === 'kanban' ? 'text-white' : 'text-gray-400 group-hover:text-indigo-600'}`}></i>
                    {isSidebarOpen && <span className="font-medium">Quadro Kanban</span>}
                  </button>

                  {isSidebarOpen ? (
                     <hr className="my-4 border-gray-200 w-5/6 mx-auto" />
                  ) : (
                     <hr className="my-4 border-gray-200 w-8 mx-auto" />
                  )}

                  <button onClick={() => setActiveTab('dir')} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl transition-all duration-200 group ${activeTab === 'dir' ? 'bg-gradient-to-r from-emerald-600 to-emerald-500 text-white shadow-lg' : 'text-gray-500 hover:bg-gray-50 hover:text-emerald-600'}`}>
                    <i className={`fas fa-chart-pie text-xl shrink-0 ${activeTab === 'dir' ? 'text-white' : 'text-gray-400 group-hover:text-emerald-600'}`}></i>
                    {isSidebarOpen && <span className="font-medium text-left leading-tight">Indicadores de Diretoria</span>}
                  </button>

                  {isSidebarOpen ? (
                     <hr className="my-4 border-gray-200 w-5/6 mx-auto" />
                  ) : (
                     <hr className="my-4 border-gray-200 w-8 mx-auto" />
                  )}

                  <button onClick={() => setActiveTab('gov_bi')} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl transition-all duration-200 group ${activeTab === 'gov_bi' ? 'bg-gradient-to-r from-orange-600 to-orange-500 text-white shadow-lg' : 'text-gray-500 hover:bg-gray-50 hover:text-orange-600'}`}>
                    <i className={`fas fa-database text-xl shrink-0 ${activeTab === 'gov_bi' ? 'text-white' : 'text-gray-400 group-hover:text-orange-600'}`}></i>
                    {isSidebarOpen && <span className="font-medium text-left leading-tight">Indicadores Governança</span>}
                  </button>
                </nav>

                <div className="p-4 border-t border-gray-100 bg-gray-50/50 shrink-0">
                   {isSidebarOpen ? (
                     <div className="flex items-center gap-3">
                       <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-600 to-purple-600 text-white flex items-center justify-center text-sm font-bold shadow-md">CD</div>
                       <div className="overflow-hidden"><p className="text-sm font-bold text-gray-700 truncate">Célula Desempenho</p><div className="flex items-center gap-1.5 text-[10px] text-green-600 font-medium bg-green-100 px-2 py-0.5 rounded-full w-fit mt-0.5"><div className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div> Online</div></div>
                     </div>
                   ) : (
                     <div className="flex justify-center"><div className="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">CD</div></div>
                   )}
                </div>
              </div>

              <div className="flex-1 flex flex-col overflow-hidden relative z-10">
                <header className="h-20 flex items-center justify-between px-8">
                   <h1 className="text-2xl font-bold text-white drop-shadow-md">Portal CSC</h1>
                </header>

                <main className="flex-1 overflow-y-auto p-4 md:p-8 pt-2">
                  <div className="max-w-[1800px] mx-auto h-full pb-10">
                    {activeTab === 'projects' && <ProjectsModule user={user} />}
                    {activeTab === 'dir' && <DirectorateContainer user={user} />}
                    {activeTab === 'gov_bi' && <GovBiContainer user={user} />}
                    {activeTab === 'kanban' && <KanbanModule user={user} />}
                  </div>
                </main>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PortalCSC />);
    </script>
</body>
</html>
